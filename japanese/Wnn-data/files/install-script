#!/bin/sh
# installation script for Japanese Wnn 4.2

yesno() {
    local question answer

    question=$1
    while :; do
    	read answer?"${question} (y/n) [y]"
	case "${answer}" in
	[Nn]*)		return 1;;
	[Yy]*)		return 0;;
	"")		return 0;;
	esac
	echo "Please answer yes or no."
    done
}

create_wnn() {
	local uname begin gid
	uname='wnn'
	begin=128
	while [ X`id -u $begin 2>/dev/null` == X$begin ]
	do
		begin=`expr $begin + 1`
	done
	echo "Creating user wnn ($begin)"
	gid=`id -g bin`
	chpass -a "wnn:*:${begin}:${gid}::::Wnn server:/root:/sbin/nologin" || exit 1
}
	


echo ""
if id -u wnn >/dev/null 2>/dev/null
then
    echo "So, user wnn already exists !"
else
    echo "You need a user named wnn"
    if yesno "Would you like to create it automatically now"; then
	create_wnn
    else
	echo "You still need to run /usr/local/lib/wnn/install-script"
	echo "to finish Wnn installation later"
	exit 0
    fi
fi

case "$1" in
japanese)
	testdir="/var/dict/ja_JP"
	sys_dirs="/var/dict/ja_JP/pubdic var/dict/ja_JP/wnncons"
	usr_dirs=/var/dict/ja_JP/usr
	wnntouch=/usr/local/bin/wnntouch
	wnnserver=/usr/local/bin/jserver;;
chinese)
	testdir="/var/dict/zh_CN"
	sys_dirs="/var/dict/zh_CN/sys var/dict/zh_TW/sys"
	usr_dirs="/var/dict/zh_CN/usr /var/dict/zh_TW/usr"
	wnntouch=/usr/local/bin/cwnntouch
	wnnserver=/usr/local/bin/cserver;;
korean)
	testdir="/var/dict/ko_KR"
	sys_dirs="/var/dict/ko_KR/sys"
	usr_dirs=/var/dict/ko_KR/usr
	wnntouch=/usr/local/bin/kwnntouch
	wnnserver=/usr/local/bin/kserver;;
	;;
esac

# installation not yet complete, bail out
[ -e $wnntouch ] || exit 0

chown wnn $wnnserver
chmod u+s $wnnserver

# base directory not yet present, bail out

[ -d $testdir ] || exit 0

for dir in $sys_dirs; do
  $wnntouch $dir/*
done

for dir in $usr_dirs; do
  if [ ! -d $dir ]; then
    mkdir -p $dir
  fi
  chown wnn $dir
done
chmod -R u+w $dir
