$OpenBSD: patch-build_libreoffice_configure_in,v 1.2 2010/11/18 19:17:34 robert Exp $
--- build/libreoffice/configure.in.orig.port	Mon Nov  8 14:13:04 2010
+++ build/libreoffice/configure.in	Thu Nov 18 09:58:11 2010
@@ -4189,25 +4189,27 @@ if test -n "$with_system_db" -o -n "$with_system_libs"
     test "$with_system_db" != "no"; then
     SYSTEM_DB=YES
     AC_MSG_RESULT([external])
-    AC_CHECK_HEADER(db.h, [ DB_INCLUDES=/usr/include ],
-        [
-             CFLAGS=-I/usr/include/db4
-             AC_CHECK_HEADER(db4/db.h,
-             [ DB_INCLUDES=/usr/include/db4 ],
-             [ AC_MSG_ERROR(no. install the db4 libraries) ], []+             )
-        ], []
-    )
+    for dbver in -5.0 5.0 -5 5 -4.8 4.8 -4.7 4.7 -4 4 ''; do
+       AC_CHECK_HEADER(db$dbver/db.h, [ DB_INCLUDES="/usr/local/include/db$dbver"; break ])
+    done
+    if test "$DB_INCLUDES" = ""; then
+       AC_MSG_ERROR(no. install the db4-dev package)
+    fi
     AC_MSG_CHECKING([whether db is at least 4.1])
     AC_TRY_RUN([
-#include <db.h>
+#include <db4/db.h>
 
 int main(int argc, char **argv) {
        if(DB_VERSION_MAJOR > 4 || (DB_VERSION_MAJOR == 4 && DB_VERSION_MINOR >= 1)) return 0;
        else return 1;
 }
     ], [AC_MSG_RESULT([yes])], [AC_MSG_ERROR([no. you need at least db 4.1])])
-    AC_HAVE_LIBRARY(db, [],
-      [AC_MSG_ERROR([db not installed or functional])], [])
+    save_LIBS="$LIBS"
+    for dbver in -5.0 5.0 -5 5 -4.8 4.8 -4.7 4.7 -4 4 ''; do
+    AC_CHECK_LIB(db$dbver, db_create, [ DB_LIB="db$dbver"; DB_CPPLIB="db_cxx$dbver"; LIBS="-ldb$dbver $LIBS"; break ])
+    done
+    AC_CHECK_FUNC(db_create, [], [ AC_MSG_ERROR([db not installed or functional]) ])
+    LIBS="$save_LIBS"
     SCPDEFS="$SCPDEFS -DSYSTEM_DB"
 else
     AC_MSG_RESULT([internal])
@@ -4216,6 +4218,8 @@ else
 fi
 AC_SUBST(SYSTEM_DB)
 AC_SUBST(DB_VERSION)
+AC_SUBST(DB_LIB)
+AC_SUBST(DB_CPPLIB)
 AC_SUBST(DB_INCLUDES)
 AC_SUBST(DB_JAR)
 
@@ -5087,15 +5091,15 @@ if test -n "$with_system_icu" -o -n "$with_system_libs
    AC_LANG_PUSH([C++])
    AC_MSG_CHECKING([for unicode/rbbi.h])
    AC_TRY_CPP(unicode/rbbi.h, AC_MSG_RESULT([checked.]), AC_MSG_ERROR([icu headers not found.]))
-   AC_PATH_PROG(SYSTEM_GENBRK, genbrk, [], [$PATH:/usr/sbin:/sbin])
+   AC_PATH_PROG(SYSTEM_GENBRK, genbrk, [], [$PATH:/usr/local/bin:/usr/sbin:/sbin])
    if test -z "$SYSTEM_GENBRK"; then
       AC_MSG_ERROR([\"genbrk\" not found in \$PATH, install the icu development tool \"genbrk"\])
    fi
-   AC_PATH_PROG(SYSTEM_GENCCODE, genccode, [], [$PATH:/usr/sbin:/sbin])
+   AC_PATH_PROG(SYSTEM_GENCCODE, genccode, [], [$PATH:/usr/local/sbin:/usr/sbin:/sbin])
    if test -z "$SYSTEM_GENCCODE"; then
       AC_MSG_ERROR([\"genccode\" not found in \$PATH, install the icu development tool \"genccode"\])
    fi
-   AC_PATH_PROG(SYSTEM_GENCMN, gencmn, [], [$PATH:/usr/sbin:/sbin])
+   AC_PATH_PROG(SYSTEM_GENCMN, gencmn, [], [$PATH:/usr/local/sbin:/usr/sbin:/sbin])
    if test -z "$SYSTEM_GENCMN"; then
       AC_MSG_ERROR([\"gencmn\" not found in \$PATH, install the icu development tool \"gencmn"\])
    fi
@@ -6219,6 +6223,8 @@ AC_MSG_CHECKING([whether to build the OpenGL Transitio
 ENABLE_OPENGL=
 
 if test "x$enable_opengl" != "xno" ; then
+   save_LDFLAGS=$LDFLAGS
+   LDFLAGS="$LDFLAGS -lm"
    AC_MSG_RESULT([yes])
    AC_CHECK_HEADER(GL/gl.h, [],
                    [AC_MSG_ERROR([OpenGL headers not found])], [])
@@ -6227,6 +6233,7 @@ if test "x$enable_opengl" != "xno" ; then
    AC_CHECK_LIB(GLU, main, [],
      [AC_MSG_ERROR(libGLU not installed or functional)], [])
    ENABLE_OPENGL=TRUE
+   LDFLAGS=$save_LDFLAGS
 else
    AC_MSG_RESULT([no])
 fi
@@ -6637,15 +6644,14 @@ dnl ==================================================
 
 KDE_CFLAGS=""
 KDE_LIBS=""
-MOC="moc"
 if test "$test_kde" = "yes" -a "$ENABLE_KDE" = "TRUE" ; then
     dnl Search paths for Qt3 and KDE3
     if test "$build_cpu" != "x86_64" ; then
-        qt_incdirs="$QTINC /usr/local/qt/include /usr/include/qt /usr/include /usr/X11R6/include/X11/qt /usr/X11R6/include/qt /usr/lib/qt3/include /usr/lib/qt/include /usr/share/qt3/include $x_includes"
-        qt_libdirs="$QTLIB /usr/local/qt/lib /usr/lib/qt /usr/lib /usr/X11R6/lib/X11/qt /usr/X11R6/lib/qt /usr/lib/qt3/lib /usr/lib/qt/lib /usr/share/qt3/lib $x_libraries"
+        qt_incdirs="$QTINC /usr/local/qt/include /usr/include/qt /usr/include /usr/X11R6/include/X11/qt /usr/X11R6/include/qt /usr/lib/qt3/include /usr/lib/qt/include /usr/share/qt3/include /usr/local/include/X11/qt3 $x_includes"
+        qt_libdirs="$QTLIB /usr/local/qt/lib /usr/lib/qt /usr/lib /usr/X11R6/lib/X11/qt /usr/X11R6/lib/qt /usr/lib/qt3/lib /usr/lib/qt/lib /usr/share/qt3/lib /usr/local/lib/qt3 $x_libraries"
     else
-        qt_incdirs="$QTINC /usr/local/qt/include /usr/include/qt /usr/include /usr/X11R6/include/X11/qt /usr/X11R6/include/qt /usr/lib64/qt3/include /usr/lib64/qt/include /usr/share/qt3/include /usr/lib/qt3/include /usr/lib/qt/include $x_includes"
-        qt_libdirs="$QTLIB /usr/local/qt/lib64 /usr/lib64/qt /usr/lib64 /usr/X11R6/lib64/X11/qt /usr/X11R6/lib64/qt /usr/lib64/qt3/lib64 /usr/lib64/qt/lib64 /usr/share/qt3/lib64 /usr/local/qt/lib /usr/lib/qt /usr/lib /usr/X11R6/lib/X11/qt /usr/X11R6/lib/qt /usr/lib/qt3/lib /usr/lib/qt/lib /usr/share/qt3/lib $x_libraries"
+        qt_incdirs="$QTINC /usr/local/qt/include /usr/include/qt /usr/include /usr/X11R6/include/X11/qt /usr/X11R6/include/qt /usr/lib64/qt3/include /usr/lib64/qt/include /usr/share/qt3/include /usr/lib/qt3/include /usr/lib/qt/include /usr/local/include/X11/qt3 $x_includes"
+        qt_libdirs="$QTLIB /usr/local/qt/lib64 /usr/lib64/qt /usr/lib64 /usr/X11R6/lib64/X11/qt /usr/X11R6/lib64/qt /usr/lib64/qt3/lib64 /usr/lib64/qt/lib64 /usr/share/qt3/lib64 /usr/local/qt/lib /usr/lib/qt /usr/lib /usr/X11R6/lib/X11/qt /usr/X11R6/lib/qt /usr/lib/qt3/lib /usr/lib/qt/lib /usr/share/qt3/lib /usr/local/lib/qt3 $x_libraries"
     fi
     if test -n "$QTDIR" ; then
         qt_incdirs="$QTDIR/include $qt_incdirs"
@@ -6673,9 +6679,9 @@ if test "$test_kde" = "yes" -a "$ENABLE_KDE" = "TRUE" 
 
     dnl What to test
     qt_test_include="qstyle.h"
-    qt_test_library="libqt-mt.so"
+    qt_test_library="libqt-mt.so*"
     kde_test_include="kapp.h"
-    kde_test_library="libDCOP.so"
+    kde_test_library="libDCOP.so*"
 
     dnl Check for Qt3 headers
     AC_MSG_CHECKING([for Qt3 headers])
@@ -6696,7 +6702,7 @@ your Qt3 installation by exporting QTDIR before runnin
     AC_MSG_CHECKING([for Qt3 libraries])
     qt_libdir="no"
     for qt_check in $qt_libdirs ; do
-        if test -r "$qt_check/$qt_test_library" ; then
+        if test -r "`ls $qt_check/$qt_test_library 2>/dev/null | head -1`" ; then
             qt_libdir="$qt_check"
             break
         fi
@@ -6733,7 +6739,7 @@ your KDE3 installation by exporting KDEDIR before runn
     AC_MSG_CHECKING([for KDE3 libraries])
     kde_libdir="no"
     for kde_check in $kde_libdirs ; do
-        if test -r "$kde_check/$kde_test_library" ; then
+        if test -r "`ls $kde_check/$kde_test_library 2>/dev/null | head -1`" ; then
             kde_libdir="$kde_check"
             break
         fi
