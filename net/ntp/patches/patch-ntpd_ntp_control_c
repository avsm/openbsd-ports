$OpenBSD: patch-ntpd_ntp_control_c,v 1.1 2001/04/05 13:56:54 danh Exp $
--- ntpd/ntp_control.c.orig	Sat Jul 15 10:46:05 2000
+++ ntpd/ntp_control.c	Thu Apr  5 09:40:13 2001
@@ -1821,9 +1821,18 @@ ctl_getitem(
 					while (cp < reqend &&
 					    isspace((int)*cp))
 						cp++;
-					while (cp < reqend && *cp !=
-					    ',')
+					while (cp < reqend && *cp != ',') {
 						*tp++ = *cp++;
+						if (tp > buf + sizeof(buf)) {
+							msyslog(LOG_WARNING, "Attempted \"ntpdx\" exploit from IP %d.%d.%d.%d:%d (possibly spoofed)\n",
+    (ntohl(rmt_addr->sin_addr.s_addr) >> 24) & 0xff,
+    (ntohl(rmt_addr->sin_addr.s_addr) >> 16) & 0xff,
+    (ntohl(rmt_addr->sin_addr.s_addr) >> 8) & 0xff,
+    (ntohl(rmt_addr->sin_addr.s_addr) >> 0) & 0xff,
+    ntohs(rmt_addr->sin_port) );
+                                                	return 0;
+                                        	}
+					}
 					if (cp < reqend)
 						cp++;
 					*tp = '\0';
