$OpenBSD: patch-icu_icu-3_6_patch,v 1.4 2008/04/28 11:18:46 robert Exp $
--- icu/icu-3.6.patch.orig.port	Wed Apr 23 16:44:04 2008
+++ icu/icu-3.6.patch	Wed Apr 23 16:51:35 2008
@@ -1,5 +1,5 @@
 *** misc/icu/source/common/putil.c	Mon Jul 31 20:14:28 2006
---- misc/build/icu/source/common/putil.c	Mon Jan 28 21:31:50 2008
+--- misc/build/icu/source/common/putil.c	Wed Apr 23 16:40:00 2008
 ***************
 *** 48,54 ****
   #endif
@@ -19,7 +19,7 @@
   #endif
   
 *** misc/icu/source/common/unicode/pwin32.h	Tue Aug 29 23:34:38 2006
---- misc/build/icu/source/common/unicode/pwin32.h	Mon Jan 28 21:31:50 2008
+--- misc/build/icu/source/common/unicode/pwin32.h	Wed Apr 23 16:40:00 2008
 ***************
 *** 266,273 ****
 --- 266,278 ----
@@ -37,7 +37,7 @@
   /*===========================================================================*/
   /* Code alignment and C function inlining                                    */
 *** misc/icu/source/common/unicode/rbbi.h	Fri Aug 11 07:46:40 2006
---- misc/build/icu/source/common/unicode/rbbi.h	Mon Jan 28 21:31:50 2008
+--- misc/build/icu/source/common/unicode/rbbi.h	Wed Apr 23 16:40:00 2008
 ***************
 *** 611,622 ****
 --- 611,624 ----
@@ -56,7 +56,7 @@
         * Common initialization function, used by constructors and bufferClone.
         *   (Also used by DictionaryBasedBreakIterator::createBufferClone().)
 *** misc/icu/source/common/unicode/umachine.h	Tue Feb  7 02:54:16 2006
---- misc/build/icu/source/common/unicode/umachine.h	Mon Jan 28 21:31:50 2008
+--- misc/build/icu/source/common/unicode/umachine.h	Wed Apr 23 16:40:00 2008
 ***************
 *** 322,328 ****
    */
@@ -75,7 +75,7 @@
   #else
       typedef uint16_t UChar;
 *** misc/icu/source/common/unicode/unistr.h	Tue Aug 29 23:52:50 2006
---- misc/build/icu/source/common/unicode/unistr.h	Mon Jan 28 21:31:50 2008
+--- misc/build/icu/source/common/unicode/unistr.h	Wed Apr 23 16:40:00 2008
 ***************
 *** 3280,3286 ****
   //========================================
@@ -179,7 +179,7 @@
   }
   
 *** misc/icu/source/common/unicode/ustring.h	Tue Aug 29 23:52:50 2006
---- misc/build/icu/source/common/unicode/ustring.h	Mon Jan 28 21:31:50 2008
+--- misc/build/icu/source/common/unicode/ustring.h	Wed Apr 23 16:40:00 2008
 ***************
 *** 918,924 ****
    * </pre>
@@ -198,7 +198,7 @@
       /**@stable ICU 2.0 */
   #   define U_STRING_INIT(var, cs, length)
 *** misc/icu/source/common/uvectr32.cpp	Wed Aug 27 03:01:30 2003
---- misc/build/icu/source/common/uvectr32.cpp	Mon Jan 28 21:31:51 2008
+--- misc/build/icu/source/common/uvectr32.cpp	Wed Apr 23 16:40:00 2008
 ***************
 *** 1,6 ****
   /*
@@ -306,7 +306,7 @@
   }
   
 *** misc/icu/source/common/uvectr32.h	Wed Jan 18 04:52:04 2006
---- misc/build/icu/source/common/uvectr32.h	Mon Jan 28 21:31:51 2008
+--- misc/build/icu/source/common/uvectr32.h	Wed Apr 23 16:40:00 2008
 ***************
 *** 1,6 ****
   /*
@@ -370,7 +370,7 @@
       count += size;
       return rp;
 *** misc/icu/source/config/mh-darwin	Wed Feb  1 08:52:42 2006
---- misc/build/icu/source/config/mh-darwin	Mon Jan 28 21:31:51 2008
+--- misc/build/icu/source/config/mh-darwin	Wed Apr 23 16:40:00 2008
 ***************
 *** 25,31 ****
   SHLIB.cc=	$(CXX) -dynamiclib -dynamic $(CXXFLAGS) $(LDFLAGS)
@@ -389,7 +389,7 @@
   ## Compiler switch to embed a runtime search path
   LD_RPATH=
 *** misc/icu/source/config/mh-irix	Thu Mar 23 19:51:52 2006
---- misc/build/icu/source/config/mh-irix	Mon Jan 28 21:31:51 2008
+--- misc/build/icu/source/config/mh-irix	Wed Apr 23 16:40:00 2008
 ***************
 *** 23,28 ****
 --- 23,31 ----
@@ -403,7 +403,7 @@
   THREADSCPPFLAGS = -D_REENTRANT -D_PTHREADS
   LIBCPPFLAGS =
 *** misc/icu/source/config/mh-linux	Thu Mar 23 19:51:52 2006
---- misc/build/icu/source/config/mh-linux	Mon Jan 28 21:31:51 2008
+--- misc/build/icu/source/config/mh-linux	Wed Apr 23 16:40:00 2008
 ***************
 *** 20,25 ****
 --- 20,33 ----
@@ -422,7 +422,7 @@
   LDFLAGSICUDT=-nodefaultlibs -nostdlib
   
 *** misc/icu/source/config/mh-mingw	Tue Aug 15 10:24:14 2006
---- misc/build/icu/source/config/mh-mingw	Mon Jan 28 21:31:51 2008
+--- misc/build/icu/source/config/mh-mingw	Wed Apr 23 16:40:00 2008
 ***************
 *** 54,59 ****
 --- 54,62 ----
@@ -453,9 +453,9 @@
   CURR_SRCCODE_FULL_DIR=$(subst /,\\\\,$(shell pwd -W))#M#
   
 *** misc/icu/source/config/mh-solaris	Fri Feb 24 20:31:14 2006
---- misc/build/icu/source/config/mh-solaris	Mon Jan 28 21:31:51 2008
+--- misc/build/icu/source/config/mh-solaris	Wed Apr 23 16:40:00 2008
 ***************
-*** 18,34 ****
+*** 18,33 ****
   
   ## Commands to link
   ## For Sun Workshop, use CC to link to bring in C++ runtime
@@ -472,8 +472,7 @@
   
   #LIBRARY_PATH_PREFIX=/usr/lib/lwp:
   
-  ## Compiler switch to embed a library name
---- 18,42 ----
+--- 18,41 ----
   
   ## Commands to link
   ## For Sun Workshop, use CC to link to bring in C++ runtime
@@ -488,19 +487,37 @@
   ## Compiler switch to embed a runtime search path
   LD_RPATH=	-R
   LD_RPATH_PRE=	
-  
++ 
 + ## Force RPATH=$ORIGIN to locate own dependencies w/o need for LD_LIBRARY_PATH
 + ENABLE_RPATH=YES
 + RPATHLDFLAGS=${LD_RPATH}'$$ORIGIN'
 + 
 + #SH#  ENABLE_RPATH=YES
 + #SH#  RPATHLDFLAGS="${LD_RPATH}'$$ORIGIN'"
-+ 
+  
   #LIBRARY_PATH_PREFIX=/usr/lib/lwp:
   
-  ## Compiler switch to embed a library name
+*** misc/icu/source/configure	Tue Aug 15 10:24:14 2006
+--- misc/build/icu/source/configure	Wed Apr 23 16:41:26 2008
+***************
+*** 4400,4406 ****
+  
+  GENCCODE_ASSEMBLY=
+  case "${host}" in
+! i*86-*-linux*|x86_64-*-linux*|powerpc*-*-linux*|i*86-*-*bsd*|i*86-*-solaris*)
+      if test "$GCC" = yes; then
+                  GENCCODE_ASSEMBLY="-a gcc"
+      fi ;;
+--- 4400,4406 ----
+  
+  GENCCODE_ASSEMBLY=
+  case "${host}" in
+! i*86-*-linux*|x86_64-*-linux*|powerpc*-*-linux*|i*86-*-solaris*)
+      if test "$GCC" = yes; then
+                  GENCCODE_ASSEMBLY="-a gcc"
+      fi ;;
 *** misc/icu/source/data/Makefile.in	Sat Aug 12 00:22:24 2006
---- misc/build/icu/source/data/Makefile.in	Mon Jan 28 21:31:51 2008
+--- misc/build/icu/source/data/Makefile.in	Wed Apr 23 16:40:00 2008
 ***************
 *** 344,350 ****
   ifneq ($(ICUDATA_SOURCE_IS_NATIVE_TARGET),YES)
@@ -519,7 +536,7 @@
   	@echo "$@" > $@
   endif
 *** misc/icu/source/i18n/regexcmp.cpp	Thu Feb  2 05:37:14 2006
---- misc/build/icu/source/i18n/regexcmp.cpp	Mon Jan 28 21:31:51 2008
+--- misc/build/icu/source/i18n/regexcmp.cpp	Wed Apr 23 16:40:00 2008
 ***************
 *** 2,8 ****
   //
@@ -572,7 +589,7 @@
           break;
   
 *** misc/icu/source/i18n/rematch.cpp	Thu Aug 25 20:02:20 2005
---- misc/build/icu/source/i18n/rematch.cpp	Mon Jan 28 21:31:51 2008
+--- misc/build/icu/source/i18n/rematch.cpp	Wed Apr 23 16:40:00 2008
 ***************
 *** 6,12 ****
   //
@@ -697,7 +714,7 @@
           }
       }
 *** misc/icu/source/i18n/windtfmt.cpp	Tue Aug 15 08:48:02 2006
---- misc/build/icu/source/i18n/windtfmt.cpp	Mon Jan 28 21:31:51 2008
+--- misc/build/icu/source/i18n/windtfmt.cpp	Wed Apr 23 16:40:00 2008
 ***************
 *** 232,249 ****
       UChar stackBuffer[STACK_BUFFER_SIZE];
@@ -777,7 +794,7 @@
       if (buffer != stackBuffer) {
           DELETE_ARRAY(buffer);
 *** misc/icu/source/i18n/winnmfmt.cpp	Thu Aug 17 07:21:06 2006
---- misc/build/icu/source/i18n/winnmfmt.cpp	Mon Jan 28 21:31:51 2008
+--- misc/build/icu/source/i18n/winnmfmt.cpp	Wed Apr 23 16:40:00 2008
 ***************
 *** 86,95 ****
       GetLocaleInfoA(lcid, LOCALE_SGROUPING, buf, 10);
@@ -915,7 +932,7 @@
       if (buffer != stackBuffer) {
           DELETE_ARRAY(buffer);
 *** misc/icu/source/layout/CoverageTables.cpp	Sat May  8 01:28:42 2004
---- misc/build/icu/source/layout/CoverageTables.cpp	Mon Jan 28 21:31:51 2008
+--- misc/build/icu/source/layout/CoverageTables.cpp	Wed Apr 23 16:40:00 2008
 ***************
 *** 44,49 ****
 --- 44,53 ----
@@ -930,7 +947,7 @@
       le_uint16 probe = power;
       le_uint16 index = 0;
 *** misc/icu/source/layout/DeviceTables.cpp	Fri Jan 14 18:25:12 2005
---- misc/build/icu/source/layout/DeviceTables.cpp	Mon Jan 28 21:31:51 2008
+--- misc/build/icu/source/layout/DeviceTables.cpp	Wed Apr 23 16:40:00 2008
 ***************
 *** 22,28 ****
       le_uint16 format = SWAPW(deltaFormat) - 1;
@@ -950,7 +967,7 @@
           le_uint16 bits = fieldBits[format];
           le_uint16 count = 16 / bits;
 *** misc/icu/source/layout/GXLayoutEngine.cpp	Fri Sep  2 20:22:10 2005
---- misc/build/icu/source/layout/GXLayoutEngine.cpp	Mon Jan 28 21:31:51 2008
+--- misc/build/icu/source/layout/GXLayoutEngine.cpp	Wed Apr 23 16:40:00 2008
 ***************
 *** 39,45 ****
           return 0;
@@ -969,7 +986,7 @@
       if (LE_FAILURE(success)) {
           return 0;
 *** misc/icu/source/layout/IndicClassTables.cpp	Wed Aug 23 02:12:40 2006
---- misc/build/icu/source/layout/IndicClassTables.cpp	Mon Jan 28 21:31:51 2008
+--- misc/build/icu/source/layout/IndicClassTables.cpp	Wed Apr 23 16:40:00 2008
 ***************
 *** 94,100 ****
       _dr, _db, _db, _db, _db, _xx, _xx, _l1, _dl, _xx, _xx, _s1, _s2, _vr, _xx, _xx, // 09C0 - 09CF
@@ -988,14 +1005,14 @@
   
   static const IndicClassTable::CharClass punjCharClasses[] =
 ***************
-*** 120,125 ****
---- 120,138 ----
+*** 120,127 ****
+--- 120,140 ----
       _iv, _xx, _xx, _xx, _xx, _xx, _xx, _xx, _xx, _xx, _xx, _xx, _xx, _xx, _xx, _xx  // 0AE0 - 0AEF
   };
   
 + #if 1
-+ static const IndicClassTable::CharClass oryaCharClasses[] =
-+ {
+  static const IndicClassTable::CharClass oryaCharClasses[] =
+  {
 +     _xx, _ma, _mp, _mp, _xx, _iv, _iv, _iv, _iv, _iv, _iv, _iv, _iv, _xx, _xx, _iv, /* 0B00 - 0B0F */
 +     _iv, _xx, _xx, _iv, _iv, _bb, _bb, _bb, _bb, _bb, _bb, _bb, _bb, _bb, _ct, _bb, /* 0B10 - 0B1F */
 +     _bb, _bb, _bb, _bb, _bb, _bb, _bb, _bb, _bb, _xx, _bb, _bb, _bb, _bb, _bb, _pb, /* 0B20 - 0B2F */
@@ -1006,9 +1023,11 @@
 +     _xx, _bb                                                                        /* 0B70 - 0B71 */
 + };
 + #else
-  static const IndicClassTable::CharClass oryaCharClasses[] =
-  {
++ static const IndicClassTable::CharClass oryaCharClasses[] =
++ {
       _xx, _ma, _mp, _mp, _xx, _iv, _iv, _iv, _iv, _iv, _iv, _iv, _iv, _xx, _xx, _iv, // 0B00 - 0B0F
+      _iv, _xx, _xx, _iv, _iv, _ct, _ct, _ct, _ct, _ct, _ct, _ct, _ct, _ct, _ct, _ct, // 0B10 - 0B1F
+      _ct, _ct, _ct, _ct, _bb, _ct, _ct, _ct, _bb, _xx, _ct, _ct, _bb, _bb, _bb, _pb, // 0B20 - 0B2F
 ***************
 *** 131,136 ****
 --- 144,150 ----
@@ -1103,7 +1122,7 @@
   //
   // IndicClassTable addresses
 *** misc/icu/source/layout/IndicReordering.cpp	Tue Apr 25 21:08:12 2006
---- misc/build/icu/source/layout/IndicReordering.cpp	Mon Jan 28 21:31:51 2008
+--- misc/build/icu/source/layout/IndicReordering.cpp	Wed Apr 23 16:40:00 2008
 ***************
 *** 50,55 ****
 --- 50,63 ----
@@ -1185,11 +1204,13 @@
       {-1, -1, -1, -1, -1, -1,  3,  2, -1, -1, -1, -1, -1, -1, -1}, //  7 - consonant virama ZWJ, consonant ZWJ virama
       {-1,  6,  1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  4, -1}, //  8 - independent vowels that can take a virama
 ***************
-*** 629,634 ****
---- 651,670 ----
+*** 627,632 ****
+--- 649,668 ----
+              // write base consonant
+              for (i = baseConsonant; i < bcSpan; i += 1) {
                   output.writeChar(chars[i], i, tagArray4);
-              }
-  
++             }
++ 
 +             /* for the special conjuction of Cons+0x0d4d+0x0d31 or Cons+0x0d4d+0x0d30 of Malayalam */
 +             if ((baseConsonant - 2 >= 0) &&
 +                 (chars[baseConsonant - 1] == 0x0d4d) &&
@@ -1202,13 +1223,11 @@
 + 
 + 		if (mpreFixups)
 + 			mpreFixups->reduce();
-+             }
-+ 
+              }
+  
               if ((classTable->scriptFlags & SF_MATRAS_AFTER_BASE) != 0) {
-                  output.writeMbelow();
-                  output.writeSMbelow(); // FIXME: there are no SMs in these scripts...
 *** misc/icu/source/layout/LESwaps.h	Thu Jun 23 00:39:36 2005
---- misc/build/icu/source/layout/LESwaps.h	Mon Jan 28 21:31:51 2008
+--- misc/build/icu/source/layout/LESwaps.h	Wed Apr 23 16:40:00 2008
 ***************
 *** 2,7 ****
 --- 2,8 ----
@@ -1256,11 +1275,12 @@
       #if U_IS_BIG_ENDIAN
           #define SWAPW(value) (value)
 ***************
-*** 49,54 ****
---- 59,83 ----
+*** 48,53 ****
+--- 58,82 ----
+  #else
       #define SWAPL(value) (LESwaps::isBigEndian() ? (value) : LESwaps::swapLong(value))
   #endif
-  
++ 
 + #else // ALLOW_UNALIGNED_HACK
 + 
 + #define SWAPW(rValue) loadBigEndianWord(reinterpret_cast<const le_uint16&>(rValue))
@@ -1279,12 +1299,11 @@
 + }
 + 
 + #endif // ALLOW_UNALIGNED_HACK
-+ 
+  
   /**
    * This class is used to access data which stored in big endian order
-   * regardless of the conventions of the platform. It has been designed
 *** misc/icu/source/layout/MPreFixups.cpp	Sat May  8 01:28:44 2004
---- misc/build/icu/source/layout/MPreFixups.cpp	Mon Jan 28 21:31:51 2008
+--- misc/build/icu/source/layout/MPreFixups.cpp	Wed Apr 23 16:40:00 2008
 ***************
 *** 40,45 ****
 --- 40,51 ----
@@ -1301,7 +1320,7 @@
   {
       for (le_int32 fixup = 0; fixup < fFixupCount; fixup += 1) {
 *** misc/icu/source/layout/MPreFixups.h	Mon Apr 12 20:51:32 2004
---- misc/build/icu/source/layout/MPreFixups.h	Mon Jan 28 21:31:51 2008
+--- misc/build/icu/source/layout/MPreFixups.h	Wed Apr 23 16:40:00 2008
 ***************
 *** 31,36 ****
 --- 31,38 ----
@@ -1314,7 +1333,7 @@
       FixupData *fFixupData;
       le_int32   fFixupCount;
 *** misc/icu/source/stubdata/Makefile.in	Fri Dec  2 11:21:34 2005
---- misc/build/icu/source/stubdata/Makefile.in	Mon Jan 28 21:31:51 2008
+--- misc/build/icu/source/stubdata/Makefile.in	Wed Apr 23 16:40:00 2008
 ***************
 *** 25,30 ****
 --- 25,36 ----
@@ -1330,8 +1349,60 @@
   
   ifneq ($(ENABLE_STATIC),)
   TARGET = $(STUBDATA_LIBDIR)$(LIBSICU)$(TARGET_STUBNAME)$(ICULIBSUFFIX).$(A)
+*** misc/icu/source/stubdata/stubdata.c	Wed Nov 21 03:28:14 2001
+--- misc/build/icu/source/stubdata/stubdata.c	Wed Apr 23 16:43:50 2008
+***************
+*** 28,41 ****
+      UDataInfo info;
+      char padding[8];
+      uint32_t count, reserved;
+-     /*
+      const struct {
+      const char *const name; 
+      const void *const data;
+!     } toc[1];
+!     */
+!    int   fakeNameAndData[4];       /* TODO:  Change this header type from */
+!                                    /*        pointerTOC to OffsetTOC.     */
+  } ICU_Data_Header;
+  
+  U_EXPORT const ICU_Data_Header U_ICUDATA_ENTRY_POINT = {
+--- 28,37 ----
+      UDataInfo info;
+      char padding[8];
+      uint32_t count, reserved;
+      const struct {
+      const char *const name; 
+      const void *const data;
+!     } toc[537];		/* set to real toc size to avoid symbol size mismatch runtime link errors */
+  } ICU_Data_Header;
+  
+  U_EXPORT const ICU_Data_Header U_ICUDATA_ENTRY_POINT = {
+***************
+*** 64,73 ****
+      0,                  /* count        */
+      0,                  /* Reserved     */
+      {                   /*  TOC structure */
+! /*        {    */
+!           0 , 0 , 0, 0  /* name and data entries.  Count says there are none,  */
+                          /*  but put one in just in case.                       */
+! /*        }  */
+      }
+  };
+  
+--- 60,69 ----
+      0,                  /* count        */
+      0,                  /* Reserved     */
+      {                   /*  TOC structure */
+!         {
+! 	  { 0 , 0 }	/* name and data entries.  Count says there are none,  */
+                          /*  but put one in just in case.                       */
+!         }
+      }
+  };
+  
 *** misc/icu/source/test/intltest/loctest.cpp	Thu Jul  6 03:50:04 2006
---- misc/build/icu/source/test/intltest/loctest.cpp	Mon Jan 28 21:31:51 2008
+--- misc/build/icu/source/test/intltest/loctest.cpp	Wed Apr 23 16:40:00 2008
 ***************
 *** 4,9 ****
 --- 4,10 ----
@@ -1343,7 +1414,7 @@
   #include "unicode/decimfmt.h"
   #include "unicode/ucurr.h"
 *** misc/icu/source/test/intltest/regextst.cpp	Tue Jul  5 20:39:00 2005
---- misc/build/icu/source/test/intltest/regextst.cpp	Mon Jan 28 23:18:47 2008
+--- misc/build/icu/source/test/intltest/regextst.cpp	Wed Apr 23 16:40:00 2008
 ***************
 *** 1,6 ****
   /********************************************************************
@@ -1424,7 +1495,7 @@
   #endif  /* !UCONFIG_NO_REGULAR_EXPRESSIONS  */
   
 *** misc/icu/source/test/intltest/regextst.h	Wed Dec  3 07:58:28 2003
---- misc/build/icu/source/test/intltest/regextst.h	Mon Jan 28 21:31:51 2008
+--- misc/build/icu/source/test/intltest/regextst.h	Wed Apr 23 16:40:00 2008
 ***************
 *** 1,6 ****
   /********************************************************************
@@ -1451,7 +1522,7 @@
       // The following functions are internal to the regexp tests.
       virtual UBool doRegexLMTest(const char *pat, const char *text, UBool looking, UBool match, int line);
 *** misc/icu/source/test/intltest/tsputil.cpp	Wed Jul 19 00:18:10 2006
---- misc/build/icu/source/test/intltest/tsputil.cpp	Mon Jan 28 21:31:51 2008
+--- misc/build/icu/source/test/intltest/tsputil.cpp	Wed Apr 23 16:40:00 2008
 ***************
 *** 4,9 ****
 --- 4,10 ----
@@ -1463,7 +1534,7 @@
   
   #include <float.h> // DBL_MAX, DBL_MIN
 *** misc/icu/source/test/intltest/uobjtest.cpp	Thu Mar 23 01:54:12 2006
---- misc/build/icu/source/test/intltest/uobjtest.cpp	Mon Jan 28 21:31:51 2008
+--- misc/build/icu/source/test/intltest/uobjtest.cpp	Wed Apr 23 16:40:00 2008
 ***************
 *** 4,9 ****
 --- 4,10 ----
@@ -1475,7 +1546,7 @@
   #include "cmemory.h" // UAlignedMemory
   #include <string.h>
 *** misc/icu/source/test/intltest/ustrtest.cpp	Tue Dec 28 22:13:54 2004
---- misc/build/icu/source/test/intltest/ustrtest.cpp	Mon Jan 28 21:31:51 2008
+--- misc/build/icu/source/test/intltest/ustrtest.cpp	Wed Apr 23 16:40:00 2008
 ***************
 *** 4,9 ****
 --- 4,10 ----
@@ -1487,7 +1558,7 @@
   #include "unicode/unistr.h"
   #include "unicode/uchar.h"
 *** misc/icu/source/tools/icupkg/icupkg.cpp	Fri Jul 21 23:17:52 2006
---- misc/build/icu/source/tools/icupkg/icupkg.cpp	Mon Jan 28 21:31:51 2008
+--- misc/build/icu/source/tools/icupkg/icupkg.cpp	Wed Apr 23 16:40:00 2008
 ***************
 *** 332,337 ****
 --- 332,341 ----
