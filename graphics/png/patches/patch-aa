--- Makefile.~1~	Fri Sep 11 13:21:25 1998
+++ Makefile	Fri Sep 11 13:30:28 1998
@@ -3,31 +3,46 @@
 # For conditions of distribution and use, see copyright notice in png.h
 
 # Where the zlib library and include files are located
-#ZLIBLIB=/usr/local/lib
-#ZLIBINC=/usr/local/include
-ZLIBLIB=../zlib
-ZLIBINC=../zlib
-
-CC=cc
-CFLAGS=-I$(ZLIBINC) -O # -g -DPNG_DEBUG=5
-LDFLAGS=-L. -L$(ZLIBLIB) -lpng -lz -lm
+ZLIBLIB=/usr/local/lib
+ZLIBINC=/usr/local/include
+#ZLIBLIB=../zlib
+#ZLIBINC=../zlib
+
+VER=1.2
+#CC=cc
+#CFLAGS=-I$(ZLIBINC) -O # -g -DPNG_DEBUG=5
+LDFLAGS=-L. -lpng -lz -lm
 
 #RANLIB=echo
 RANLIB=ranlib
 
 # where make install puts libpng.a and png.h
-prefix=/usr/local
+prefix=${PREFIX}
 
 OBJS = png.o pngset.o pngget.o pngrutil.o pngtrans.o pngwutil.o \
 	pngread.o pngrio.o pngwio.o pngwrite.o pngrtran.o \
 	pngwtran.o pngmem.o pngerror.o pngpread.o
 
-all: libpng.a pngtest
+.SUFFIXES: .c .so .o
+
+.c.so:
+	${CC} -fpic -DPIC ${CFLAGS} -c ${.IMPSRC} -o ${.TARGET}
+
+.if (${MACHINE_ARCH} != "alpha")
+all: libpng.a libpng.so.${VER}
+.else
+all: libpng.a
+.endif
 
 libpng.a: $(OBJS)
 	ar rc $@  $(OBJS)
 	$(RANLIB) $@
 
+.if (${MACHINE_ARCH} != "alpha")
+libpng.so.${VER}: $(OBJS:S/o$/so/g)
+	ld -Bshareable -x -assert pure-text -o $@ $(OBJS:S/o$/so/g) -lz
+.endif
+
 pngtest: pngtest.o libpng.a
 	$(CC) -o pngtest $(CFLAGS) pngtest.o $(LDFLAGS)
 
@@ -37,12 +52,12 @@
 install: libpng.a
 	-@mkdir $(prefix)/include
 	-@mkdir $(prefix)/lib
-	cp png.h $(prefix)/include
-	cp pngconf.h $(prefix)/include
-	chmod 644 $(prefix)/include/png.h
-	chmod 644 $(prefix)/include/pngconf.h
-	cp libpng.a $(prefix)/lib
-	chmod 644 $(prefix)/lib/libpng.a
+	${BSD_INSTALL_DATA} png.h pngconf.h $(prefix)/include
+	${BSD_INSTALL_DATA} libpng.a $(prefix)/lib
+	${RANLIB} $(prefix)/lib/libpng.a
+.if(${MACHINE_ARCH} != "alpha")
+	${BSD_INSTALL_DATA} libpng.so.${VER} $(prefix)/lib
+.endif
 
 clean:
 	rm -f *.o libpng.a pngtest pngout.png
