$OpenBSD: patch-src_lib-storage_index_maildir_maildir-uidlist_c,v 1.3 2010/09/17 22:00:18 sthen Exp $
--- src/lib-storage/index/maildir/maildir-uidlist.c.orig	Fri Sep 17 09:44:44 2010
+++ src/lib-storage/index/maildir/maildir-uidlist.c	Fri Sep 17 09:48:18 2010
@@ -89,6 +89,7 @@ struct maildir_uidlist {
 	string_t *hdr_extensions;
 
 	unsigned int recreate:1;
+	unsigned int recreate_on_change:1;
 	unsigned int initial_read:1;
 	unsigned int initial_hdr_read:1;
 	unsigned int retry_rewind:1;
@@ -758,7 +759,7 @@ maildir_uidlist_update_read(struct maildir_uidlist *ui
                         ret = -1;
 
 		if (uidlist->unsorted) {
-			uidlist->recreate = TRUE;
+			uidlist->recreate_on_change = TRUE;
 			maildir_uidlist_records_sort_by_uid(uidlist);
 		}
 		if (uidlist->next_uid <= uidlist->prev_read_uid)
@@ -1375,6 +1376,7 @@ static int maildir_uidlist_recreate(struct maildir_uid
 		uidlist->fd_size = st.st_size;
 		uidlist->last_read_offset = st.st_size;
 		uidlist->recreate = FALSE;
+		uidlist->recreate_on_change = FALSE;
 		maildir_uidlist_update_hdr(uidlist, &st);
 	}
 	if (ret < 0)
@@ -1446,7 +1448,7 @@ static int maildir_uidlist_sync_update(struct maildir_
 	}
 
 
-	if (maildir_uidlist_want_recreate(ctx))
+	if (maildir_uidlist_want_recreate(ctx) || uidlist->recreate_on_change)
 		return maildir_uidlist_recreate(uidlist);
 
 	if (!uidlist->locked_refresh || uidlist->fd == -1) {
@@ -1796,7 +1798,7 @@ static void maildir_uidlist_assign_uids(struct maildir
 		recs[dest]->flags &= ~MAILDIR_UIDLIST_REC_FLAG_MOVED;
 	}
 
-	if (ctx->uidlist->locked_refresh)
+	if (ctx->uidlist->locked_refresh && ctx->uidlist->initial_read)
 		ctx->uidlist->last_seen_uid = ctx->uidlist->next_uid-1;
 
 	ctx->new_files_count = 0;
