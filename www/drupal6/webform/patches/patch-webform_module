$OpenBSD: patch-webform_module,v 1.3 2009/10/23 10:18:35 espie Exp $
--- webform.module.orig	Thu Oct 15 03:26:46 2009
+++ webform.module	Fri Oct 23 12:17:56 2009
@@ -249,6 +249,17 @@ function webform_menu() {
     'weight' => 2,
     'type' => MENU_LOCAL_TASK,
   );
+  $items['node/%webform_menu/submission/%webform_menu_submission/download'] = array(
+    'title' => 'Download',
+    'load arguments' => array(1),
+    'page callback' => 'drupal_get_form',
+    'page arguments' => array('webform_results_download_form', 1, 3),
+    'access callback' => 'webform_results_access',
+    'access arguments' => array(1, 'access webform results'),
+    'file' => 'webform_report.inc',
+    'weight' => 7,
+    'type' => MENU_LOCAL_TASK,
+  );
 
   return $items;
 }
@@ -2117,6 +2128,7 @@ function theme_webform_mail_headers($form_values, $nod
  */
 function _webform_filter_values($string, $node = NULL, $submission = NULL, $strict = TRUE, $allow_anonymous = FALSE) {
   global $user;
+  global $webform_uid_cached;
   static $replacements;
 
   // Setup default token replacements.
@@ -2157,8 +2169,9 @@ function _webform_filter_values($string, $node = NULL,
     $replacements['unsafe']['%username'] = isset($user->name) ? $user->name : '';
     $replacements['unsafe']['%useremail'] = isset($user->mail) ? $user->mail : '';
     $replacements['unsafe']['%ip_address'] = ip_address();
-    if ($user->uid && module_exists('profile')) {
+    if ($user->uid && module_exists('profile') && $webform_uid_cached != $user->uid) {
       profile_load_profile($user);
+      $webform_uid_cached = $user->uid;
     }
     $special_tokens['unsafe']['%profile'] = $user;
 
