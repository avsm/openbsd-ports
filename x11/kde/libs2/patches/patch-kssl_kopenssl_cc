$OpenBSD: patch-kssl_kopenssl_cc,v 1.2 2001/08/21 14:20:08 espie Exp $
--- kssl/kopenssl.cc.orig	Sun Jul 29 06:55:41 2001
+++ kssl/kopenssl.cc	Tue Aug 21 16:11:26 2001
@@ -117,6 +117,51 @@ void KOpenSSLProxy::destroy() {
   _me = NULL;
 }
 
+#ifdef __OpenBSD__
+#include <qdir.h>
+#include <qstring.h>
+#include <qstringlist.h>
+
+static QString findMostRecentLib(QString dir, QString name)
+{
+	// Grab all shared libraries in the directory
+	QString filter = "lib"+name+".so.*";
+	QDir d(dir, filter);
+	if (!d.exists())
+		return NULL;
+	QStringList l = d.entryList();
+
+	// Find the best one
+	int bestmaj = -1;
+	int bestmin = -1;
+	QString best = NULL;
+	// where do we start
+	uint s = filter.length()-1;
+	for (QStringList::Iterator it = l.begin(); it != l.end(); ++it) {
+		QString numberpart = (*it).mid(s);
+		uint endmaj = numberpart.find('.');
+		if (endmaj == -1)
+			continue;
+		bool ok;
+		int maj = numberpart.left(endmaj).toInt(&ok);
+		if (!ok)
+			continue;
+		int min = numberpart.mid(endmaj+1).toInt(&ok);
+		if (!ok)
+			continue;
+		if (maj > bestmaj || (maj == bestmaj && min > bestmin)) {
+			bestmaj = maj;
+			bestmin = min;
+			best = (*it);
+		}
+	}
+	if (best.isNull())
+		return NULL;
+	else
+		return dir+"/"+best;
+}
+#endif
+
 
 KOpenSSLProxy::KOpenSSLProxy() {
 KLibLoader *ll = KLibLoader::self();
@@ -135,6 +180,13 @@ KConfig *cfg;
 
    delete cfg;
 
+#ifdef __OpenBSD__
+   {
+   QString libname = findMostRecentLib("/usr/lib", "crypto");
+   if (!libname.isNull())
+         _cryptoLib = ll->globalLibrary(libname.latin1());
+   }
+#else
    libpaths << "/usr/lib/"
             << "/usr/local/lib/"
             << "/usr/local/openssl/lib/"
@@ -163,6 +215,7 @@ KConfig *cfg;
       }
       if (_cryptoLib) break;
    }
+#endif
 
    if (_cryptoLib) {
 #ifdef HAVE_SSL 
@@ -210,6 +263,13 @@ KConfig *cfg;
 #endif
    }
 
+#ifdef __OpenBSD__
+   {
+   QString libname = findMostRecentLib("/usr/lib", "ssl");
+   if (!libname.isNull())
+         _sslLib = ll->globalLibrary(libname.latin1());
+   }
+#else
    for (QStringList::Iterator it = libpaths.begin();
                               it != libpaths.end();
                               ++it) {
@@ -222,6 +282,7 @@ KConfig *cfg;
       }
       if (_sslLib) break;
    }
+#endif
 
    if (_sslLib) {
 #ifdef HAVE_SSL 
