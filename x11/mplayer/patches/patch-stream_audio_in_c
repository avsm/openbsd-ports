$OpenBSD: patch-stream_audio_in_c,v 1.1 2009/10/11 13:36:23 edd Exp $
--- stream/audio_in.c.orig	Tue Jul 21 14:38:14 2009
+++ stream/audio_in.c	Tue Jul 21 14:52:10 2009
@@ -36,6 +36,12 @@ int audio_in_init(audio_in_t *ai, int type)
 	ai->oss.device = strdup("/dev/dsp");
 	return 0;
 #endif
+#ifdef CONFIG_SNDIO_AUDIO
+    case AUDIO_IN_SNDIO:
+	ai->sndio.hdl = NULL;
+	ai->sndio.device = strdup("default");
+	return 0;
+#endif
     default:
 	return -1;
     }
@@ -57,6 +63,12 @@ int audio_in_setup(audio_in_t *ai)
 	ai->setup = 1;
 	return 0;
 #endif
+#ifdef CONFIG_SNDIO_AUDIO
+    case AUDIO_IN_SNDIO:
+	if (ai_sndio_init(ai) < 0) return -1;
+	ai->setup = 1;
+	return 0;
+#endif
     default:
 	return -1;
     }
@@ -79,6 +91,13 @@ int audio_in_set_samplerate(audio_in_t *ai, int rate)
 	if (ai_oss_set_samplerate(ai) < 0) return -1;
 	return ai->samplerate;
 #endif
+#ifdef CONFIG_SNDIO_AUDIO
+    case AUDIO_IN_SNDIO:
+	ai->req_samplerate = rate;
+	if (!ai->setup) return 0;
+	if (ai_sndio_setup(ai) < 0) return -1;
+	return ai->samplerate;
+#endif
     default:
 	return -1;
     }
@@ -101,6 +120,13 @@ int audio_in_set_channels(audio_in_t *ai, int channels
 	if (ai_oss_set_channels(ai) < 0) return -1;
 	return ai->channels;
 #endif
+#ifdef CONFIG_SNDIO_AUDIO
+    case AUDIO_IN_SNDIO:
+	ai->req_channels = channels;
+	if (!ai->setup) return 0;
+	if (ai_sndio_setup(ai) < 0) return -1;
+	return ai->channels;
+#endif
     default:
 	return -1;
     }
@@ -129,6 +155,12 @@ int audio_in_set_device(audio_in_t *ai, char *device)
 	ai->oss.device = strdup(device);
 	return 0;
 #endif
+#ifdef CONFIG_SNDIO_AUDIO
+    case AUDIO_IN_SNDIO:
+	if (ai->sndio.device) free(ai->sndio.device);
+	ai->sndio.device = strdup(device);
+	return 0;
+#endif
     default:
 	return -1;
     }
@@ -154,6 +186,13 @@ int audio_in_uninit(audio_in_t *ai)
 	    ai->setup = 0;
 	    return 0;
 #endif
+#ifdef CONFIG_SNDIO_AUDIO
+	case AUDIO_IN_SNDIO:
+	    if (ai->sndio.hdl)
+	        sio_close(ai->sndio.hdl);
+	    ai->setup = 0;
+	    return 0;
+#endif
 	}
     }
     return -1;
@@ -170,6 +209,12 @@ int audio_in_start_capture(audio_in_t *ai)
     case AUDIO_IN_OSS:
 	return 0;
 #endif
+#ifdef CONFIG_SNDIO_AUDIO
+    case AUDIO_IN_SNDIO:
+	if (!sio_start(ai->sndio.hdl))
+	    return -1;
+	return 0;
+#endif
     default:
 	return -1;
     }
@@ -203,6 +248,19 @@ int audio_in_read_chunk(audio_in_t *ai, unsigned char 
 #ifdef CONFIG_OSS_AUDIO
     case AUDIO_IN_OSS:
 	ret = read(ai->oss.audio_fd, buffer, ai->blocksize);
+	if (ret != ai->blocksize) {
+	    if (ret < 0) {
+		mp_msg(MSGT_TV, MSGL_ERR, MSGTR_MPDEMUX_AUDIOIN_ErrReadingAudio, strerror(errno));
+	    } else {
+		mp_msg(MSGT_TV, MSGL_ERR, MSGTR_MPDEMUX_AUDIOIN_NotEnoughSamples);
+	    }
+	    return -1;
+	}
+	return ret;
+#endif
+#ifdef CONFIG_SNDIO_AUDIO
+    case AUDIO_IN_SNDIO:
+	ret = sio_read(ai->sndio.hdl, buffer, ai->blocksize);
 	if (ret != ai->blocksize) {
 	    if (ret < 0) {
 		mp_msg(MSGT_TV, MSGL_ERR, MSGTR_MPDEMUX_AUDIOIN_ErrReadingAudio, strerror(errno));
