$OpenBSD: patch-rakelib_vm_rake,v 1.2 2011/03/10 20:40:33 jeremy Exp $

Use intree versions of libffi, instead of bundled versions.

--- rakelib/vm.rake.orig	Tue Feb 15 14:46:13 2011
+++ rakelib/vm.rake	Thu Feb 17 10:14:23 2011
@@ -53,7 +53,7 @@ dep_file    = "vm/.depends.mf"
 vm_objs     = %w[ vm/drivers/cli.o ]
 vm_srcs     = %w[ vm/drivers/cli.cpp ]
 
-EX_INC      = %w[ libtommath libgdtoa onig libffi/include
+EX_INC      = %w[ libtommath libgdtoa onig
                 ].map { |f| "vm/external_libs/#{f}" }
 
 INSN_GEN    = %w[ vm/gen/instruction_names.cpp
@@ -141,11 +141,11 @@ file "vm/external_libs/libgdtoa/libgdtoa.a" => libgdto
 EXTERNALS   = %W[ vm/external_libs/libtommath/libtommath.a
                   vm/external_libs/libgdtoa/libgdtoa.a
                   vm/external_libs/onig/.libs/libonig.a
-                  vm/external_libs/libffi/.libs/libffi.a ]
+                  ${LOCALBASE}/lib/libffi.a ]
 
 INCLUDES      = EX_INC + %w[vm/test/cxxtest vm .]
 
-extra = %w!/usr/local/include /opt/local/include!
+extra = %w!${LOCALBASE}/include ${LOCALBASE}/include!
 
 extra.each do |dir|
   INCLUDES << dir if File.directory?(dir)
@@ -470,6 +470,7 @@ objs.zip(srcs).each do |obj, src|
 end
 
 files EXTERNALS do |t|
+  next if t =~ /libffi/
   path = File.join(*split_all(t.name)[0..2])
   configure_path = File.join(path, 'configure')
 
@@ -648,6 +649,7 @@ namespace :vm do
   desc "Clean up, including all external libs"
   task :distclean => :clean do
     EXTERNALS.each do |lib|
+      next if lib =~ /libffi/
       path = File.join(*(lib.split(File::SEPARATOR)[0..-2].reject{|i| i =~ /^\./}))
       system "cd #{path}; #{make} clean || true"
     end
@@ -700,12 +702,12 @@ def ex_libs # needs to be method to delay running of l
   unless defined? $ex_libs then
     $ex_libs = EXTERNALS.reverse
 
-    if File.directory?("/usr/local/lib")
-      $ex_libs << "-L/usr/local/lib"
+    if File.directory?("${LOCALBASE}/lib")
+      $ex_libs << "-L${LOCALBASE}/lib"
     end
 
-    if File.directory?("/opt/local/lib")
-      $ex_libs << "-L/opt/local/lib"
+    if File.directory?("${LOCALBASE}/lib")
+      $ex_libs << "-L${LOCALBASE}/lib"
     end
 
     $ex_libs << "-ldl" unless RUBY_PLATFORM =~ /bsd|haiku/
