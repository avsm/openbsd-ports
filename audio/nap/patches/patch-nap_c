$OpenBSD: patch-nap_c,v 1.3 2001/05/09 22:38:00 pvalchev Exp $
--- nap.c.orig	Mon Apr 23 13:23:36 2001
+++ nap.c	Sat May  5 23:32:26 2001
@@ -1545,7 +1545,9 @@ unsigned long int swapl(unsigned long in
 }
 
 /* just like connect(2), except that we time out after t seconds. No
-   timeout if t=0. If a timeout occurred, we set errno to ETIMEDOUT. */
+   timeout if t=0. If a timeout occurred, we set errno to ETIMEDOUT.
+   If we return -1, then errno is either set to a valid error number,
+   or to 255 if there was an unknown error. */
 int connect_t(int fd, struct sockaddr *serv_addr, int addlen, int t) 
 {
   int status;
@@ -1590,8 +1592,6 @@ int connect_t(int fd, struct sockaddr *s
     return(-1);
   } else if (WEXITSTATUS(status)) {
     errno = WEXITSTATUS(status);
-    if (errno==255)
-      errno = ECANCELED;
     return(-1);
   } else {
     return(0);
@@ -1638,7 +1638,7 @@ int conn(char *host, unsigned short port
     }
     
     if (connect_t(s, (struct sockaddr *)&dst, sizeof(dst), timeout) == -1) {
-      wp(wchan, "Error connecting to %s: %s\n", host, sys_errlist[errno]);
+      wp(wchan, "Error connecting to %s: %s\n", host, errno!=255 ? sys_errlist[errno] : "unknown error");
       drw(wchan);
       close(s);
       return(-1);
@@ -1707,7 +1707,7 @@ int conn(char *host, unsigned short port
   
   if (connect_t(s, (struct sockaddr *)&dst, sizeof(dst), timeout) == -1)
   {
-    wp(wchan, "Error connecting to %s:%d: %s\n", buf, port, sys_errlist[errno]);
+    wp(wchan, "Error connecting to %s:%d: %s\n", buf, port, errno!=255 ? sys_errlist[errno] : "unknown error");
     drw(wchan);
     close(s);
     free(buf);
@@ -1907,10 +1907,10 @@ void checkhotlist(int s, char *fn)
    announce the absense of news as well, otherwise be quiet. Note:
    this function may be executed in a child process. Return 1 if there
    was news, 0 if there was none, and -1 or -2 if we could not gain
-   access. In case of -1, errno is set, and in case -2, h_errno is
-   set. If fd is 1, do some special formatting, write in black and
-   white, and send the output through wp() for the log file's
-   benefit. */
+   access. In case of -1, errno is set (except that 255 is a special
+   value "unknown error"), and in case -2, h_errno is set. If fd is 1,
+   do some special formatting, write in black and white, and send the
+   output through wp() for the log file's benefit. */
 int checknv(int fd, int timeout)
 {
   int s, r;
