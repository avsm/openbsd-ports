$OpenBSD: patch-src_protocols_msn_slp_c,v 1.3 2004/09/22 05:49:56 brad Exp $
--- src/protocols/msn/slp.c.orig	Tue Aug 24 21:45:41 2004
+++ src/protocols/msn/slp.c	Wed Sep 22 01:23:39 2004
@@ -235,6 +235,8 @@ send_decline(MsnSlpCall *slpcall, const 
 	msn_slplink_queue_slpmsg(slplink, slpmsg);
 }
 
+#define MAX_FILE_NAME_LEN 0x226
+
 static void
 got_sessionreq(MsnSlpCall *slpcall, const char *branch,
 			   const char *euf_guid, const char *context)
@@ -318,6 +320,7 @@ got_sessionreq(MsnSlpCall *slpcall, cons
 		gsize bin_len;
 		guint32 file_size;
 		char *file_name;
+		gunichar2 *uni_name;
 
 		account = slpcall->slplink->session->account;
 
@@ -331,6 +334,13 @@ got_sessionreq(MsnSlpCall *slpcall, cons
 
 		gaim_base64_decode(context, &bin, &bin_len);
 		file_size = GUINT32_FROM_LE(*((gsize *)bin + 2));
+		
+		uni_name = (gunichar2 *)(bin + 20);
+		while(*uni_name != 0 && ((char *)uni_name - (bin + 20)) < MAX_FILE_NAME_LEN) {
+			*uni_name = GUINT16_FROM_LE(*uni_name);
+			uni_name++;
+		}
+		
 		file_name = g_utf16_to_utf8((const gunichar2 *)(bin + 20), -1,
 									NULL, NULL, NULL);
 
