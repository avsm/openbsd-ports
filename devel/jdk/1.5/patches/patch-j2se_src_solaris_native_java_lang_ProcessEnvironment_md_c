$OpenBSD: patch-j2se_src_solaris_native_java_lang_ProcessEnvironment_md_c,v 1.3 2007/05/01 02:05:46 kurt Exp $
--- j2se/src/solaris/native/java/lang/ProcessEnvironment_md.c.orig	Mon Apr 30 18:01:15 2007
+++ j2se/src/solaris/native/java/lang/ProcessEnvironment_md.c	Mon Apr 30 17:20:17 2007
@@ -39,7 +39,8 @@ Java_java_lang_ProcessEnvironment_environ(JNIEnv *env,
     result = (*env)->NewObjectArray(env, 2*count, byteArrCls, 0);
     if (result == NULL) return NULL;
 
-    for (i = 0; i < count; i++) {
+    count = 0;
+    for (i = 0; environ[i]; i++) {
 	jsize len = strlen(environ[i]);
 	const char * varEnd = strchr(environ[i], '=');
 	/* Ignore corrupted environment variables */
@@ -56,10 +57,11 @@ Java_java_lang_ProcessEnvironment_environ(JNIEnv *env,
 				       (jbyte*) environ[i]);
 	    (*env)->SetByteArrayRegion(env, val, 0, valLength,
 				       (jbyte*) valBeg);
-	    (*env)->SetObjectArrayElement(env, result, 2*i  , var);
-	    (*env)->SetObjectArrayElement(env, result, 2*i+1, val);
+	    (*env)->SetObjectArrayElement(env, result, 2*count  , var);
+	    (*env)->SetObjectArrayElement(env, result, 2*count+1, val);
 	    (*env)->DeleteLocalRef(env, var);
 	    (*env)->DeleteLocalRef(env, val);
+	    count++;
 	}
     }
 
