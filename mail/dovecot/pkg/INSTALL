#!/bin/sh
# $OpenBSD: INSTALL,v 1.5 2004/09/15 09:09:41 espie Exp $
#
# Pre/post-installation setup of Dovecot

PATH=/bin:/usr/bin:/sbin:/usr/sbin
PREFIX=${PKG_PREFIX:-/usr/local}
SYSCONFDIR=${SYSCONFDIR:-/etc}
CONFIG_FILE=$SYSCONFDIR/dovecot.conf
SSL_DIR=/etc/ssl
SSL_FILE=$SSL_DIR/dovecot-openssl.cnf
SAMPLE_CONFIG_DIR=$PREFIX/share/examples/dovecot
SAMPLE_CONFIG_FILE=$SAMPLE_CONFIG_DIR/dovecot-example.conf
SAMPLE_SSL_FILE=$SAMPLE_CONFIG_DIR/dovecot-openssl.cnf
DOVECOTDIR=/var/dovecot
DOVECOTUSER=_dovecot
DOVECOTGROUP=_dovecot
ID=518

do_usergroup_install()
{
  # Create Dovecot user and group
  groupinfo -e $DOVECOTGROUP
  if [ $? -eq 0 ]; then
    echo "===> Using $DOVECOTGROUP group for Dovecot"
  else
    echo "===> Creating $DOVECOTGROUP group for Dovecot"
    groupadd -g $ID $DOVECOTGROUP
  fi
  userinfo -e $DOVECOTUSER
  if [ $? -eq 0 ]; then
    echo "===> Using $DOVECOTUSER user for Dovecot"
  else
    echo "===> Creating $DOVECOTUSER user for Dovecot"
    useradd -g $DOVECOTGROUP -d /nonexistent -L daemon -c 'Dovecot Account' -s /sbin/nologin -u $ID $DOVECOTUSER
  fi
}


do_ssl_install()
{
    echo
    echo "+---------------"
    echo "| Files to facilitate the generation of a self-signed"
    echo "| certificate and key for Dovecot have been installed:"
    echo "| $SSL_FILE	(Edit this accordingly!)"
    echo "| $PREFIX/sbin/dovecot-mkcert.sh"
    echo "|"
    echo "| If this has been or will be accomplished by other means,"
    echo "| use the following paths for the files:"
    echo "| $SSL_DIR/dovecotcert.pem"
    echo "| $SSL_DIR/private/dovecot.pem"
    echo "+---------------"
    echo
}

do_var_install()
{
	install -d -o root -g wheel -m 700 $DOVECOTDIR
	install -d -o root -g $DOVECOTGROUP -m 750 $DOVECOTDIR/login
}

if [ $# -ne 2 ]; then
    echo "usage: $0 distname { PRE-INSTALL | POST-INSTALL }" >&2
    exit 1
fi

case $2 in
    PRE-INSTALL)
	do_usergroup_install
	;;
    POST-INSTALL)
            do_ssl_install $1
	if [ ! -d $DOVECOTDIR ]; then
	    do_var_install
	fi
	;;
    *)
	echo "usage: $0 distname { PRE-INSTALL | POST-INSTALL }" >&2
	exit 1
	;;
esac

exit 0
