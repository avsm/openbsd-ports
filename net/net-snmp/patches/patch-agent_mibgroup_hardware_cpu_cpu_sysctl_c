$OpenBSD: patch-agent_mibgroup_hardware_cpu_cpu_sysctl_c,v 1.3 2011/07/06 21:32:57 sthen Exp $
--- agent/mibgroup/hardware/cpu/cpu_sysctl.c.orig	Sat Jun 12 22:33:30 2010
+++ agent/mibgroup/hardware/cpu/cpu_sysctl.c	Wed Jul  6 15:07:21 2011
@@ -37,9 +37,10 @@ void _cpu_copy_stats( netsnmp_cpu_info *cpu );
      *   (including descriptions)
      */
 void init_cpu_sysctl( void ) {
-    int               i, n;
+    int               n;
     int               ncpu_mib[]  = { CTL_HW, HW_NCPU };
     int               model_mib[] = { CTL_HW, HW_MODEL };
+    size_t            i;
     char              descr[ SNMP_MAXBUF ];
     netsnmp_cpu_info  *cpu = netsnmp_cpu_get_byIdx( -1, 1 );
     strcpy(cpu->name, "Overall CPU statistics");
@@ -190,8 +191,9 @@ int netsnmp_cpu_arch_load( netsnmp_cache *cache, void 
 
 #ifdef NETSNMP_KERN_MCPU
     mcpu_stats = (NETSNMP_KERN_MCPU_TYPE *)malloc(cpu_num*sizeof(NETSNMP_KERN_MCPU_TYPE));
+    mcpu_size = sizeof(mcpu_stats);
     sysctl(mcpu_mib, 2, mcpu_stats,
-           cpu_num*sizeof(NETSNMP_KERN_MCPU_TYPE), NULL, 0);
+           &mcpu_size, NULL, 0);
     for ( i = 0; i < cpu_num; i++ ) {
         cpu = netsnmp_cpu_get_byIdx( i, 0 );
         /* XXX - per-CPU statistics - mcpu_mib[i].??? */
