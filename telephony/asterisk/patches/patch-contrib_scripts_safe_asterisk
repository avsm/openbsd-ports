$OpenBSD: patch-contrib_scripts_safe_asterisk,v 1.7 2008/05/27 22:14:34 sthen Exp $
--- contrib/scripts/safe_asterisk.orig	Mon May  5 04:22:25 2008
+++ contrib/scripts/safe_asterisk	Wed May 21 12:36:13 2008
@@ -1,20 +1,21 @@
-#!/bin/bash
+#!/bin/sh
 # vim:textwidth=80:tabstop=4:shiftwidth=4:smartindent:autoindent
 
 CLIARGS="$*"				# Grab any args passed to safe_asterisk
-TTY=9						# TTY (if you want one) for Asterisk to run on
-CONSOLE=yes					# Whether or not you want a console
-#NOTIFY=ben@alkaloid.net	# Who to notify about crashes
+TTY=""						# TTY (if you want one) for Asterisk to run on
+CONSOLE=no					# Whether or not you want a console
+NOTIFY=root					# Who to notify about crashes
 #EXEC=/path/to/somescript	# Run this command if Asterisk crashes
 MACHINE=`hostname`			# To specify which machine has crashed when getting the mail
 DUMPDROP=/tmp
 SLEEPSECS=4
 ASTSBINDIR=__ASTERISK_SBIN_DIR__
 ASTPIDFILE=__ASTERISK_VARRUN_DIR__/asterisk.pid
+VARRUNOWNER="_asterisk:wheel"	# chown __ASTERISK_VARRUN_DIR__ if it's created.
 
-# comment this line out to have this script _not_ kill all mpg123 processes when
+# uncomment this line to have this script kill all mpg123 processes when
 # asterisk exits
-KILLALLMPG123=1
+# KILLALLMPG123=1
 
 # run asterisk with this priority
 PRIORITY=0
@@ -29,7 +30,7 @@ PRIORITY=0
 # Check if Asterisk is already running.  If it is, then bug out, because
 # starting safe_asterisk when Asterisk is running is very bad.
 VERSION=`${ASTSBINDIR}/asterisk -rx 'core show version'`
-if [ "${VERSION:0:8}" = "Asterisk" ]; then # otherwise "Unable t"
+if [ "`echo $VERSION | cut -c 1-8`" = "Asterisk" ]; then
 	echo "Asterisk is already running.  $0 will exit now."
 	exit 1
 fi
@@ -74,6 +75,12 @@ else
 	# set the process's filemax to whatever set above
 	ulimit -n $MAXFILES
 
+	varrundir=`dirname $ASTPIDFILE`
+	if [ ! -d $varrundir ]; then
+		mkdir -p $varrundir
+		[ -n "$VARRUNOWNER" ] && chown $VARRUNOWNER $varrundir
+		chmod 770 $varrundir
+	fi
 fi
 
 #
@@ -170,7 +177,7 @@ run_asterisk()
 		sleep $SLEEPSECS
 		if [ $KILLALLMPG123 ]
 		then
-			killall -9 mpg123
+			pkill -9 mpg123
 		fi
 	done
 }
