$OpenBSD: patch-cap_c,v 1.2 2006/11/11 18:11:09 ckuethe Exp $
--- cap.c.orig	Fri Jul 14 01:31:23 2006
+++ cap.c	Fri Nov  3 17:59:07 2006
@@ -112,28 +112,13 @@ cap_init(const char *device, const char 
       free(tmp_filter);
    }
 
-#ifdef HAVE_PCAP_GET_SELECTABLE_FD
-   if (pcap_setnonblock(pcap, 1, errbuf) == -1)
-      errx(1, "pcap_setnonblock(): %s", errbuf);
-
-   pcap_fd = pcap_get_selectable_fd(pcap);
-   if (pcap_fd == -1)
-      errx(1, "pcap_get_selectable_fd(): there isn't one!");
-
-   verbosef("pcap_got_selectable_fd");
-#else
-   /* hax */
    pcap_fd = pcap_fileno(pcap);
 
+   /* set non-blocking */
 { int one = 1;
    if (ioctl(pcap_fd, FIONBIO, &one) == -1)
       err(1, "ioctl(pcap_fd, FIONBIO)"); }
 
-{ struct timeval t = { 0, CAP_TIMEOUT * 1000 }; /* msec -> usec */
-   if (ioctl(pcap_fd, BIOCSRTIMEOUT, &t) == -1)
-      err(1, "ioctl(pcap_fd, BIOCSRTIMEOUT)"); }
-#endif
-
 #ifdef BIOCSETWF
 {
    /* Deny all writes to the socket */
@@ -151,6 +136,7 @@ cap_init(const char *device, const char 
 #endif
 
 #ifdef BIOCLOCK
+   /* set "locked" flag (no reset) */
    if (ioctl(pcap_fd, BIOCLOCK) == -1)
       err(1, "ioctl(pcap_fd, BIOCLOCK)");
    verbosef("locked down BPF for security");
@@ -190,7 +176,7 @@ cap_poll(fd_set *read_set)
 
 #ifndef linux /* We don't use select() on Linux. */
    if (!FD_ISSET(pcap_fd, read_set)) {
-      dverbosef("cap_poll premature");
+      verbosef("cap_poll premature");
       return;
    }
 #endif
@@ -202,19 +188,29 @@ cap_poll(fd_set *read_set)
    localip_update(); /* FIXME: this might even be too often */
 
    total = 0;
-   do {
+   for (;;) {
       ret = pcap_dispatch(
             pcap,
             -1,               /* count, -1 = entire buffer */
             linkhdr->handler, /* callback func from decode.c */
             NULL);            /* user */
 
+      verbosef("ret = %d", ret); /* FIXME: debugging the FIONBIO change */
+
       if (ret < 0)
          errx(1, "pcap_dispatch(): %s", pcap_geterr(pcap));
 
       /* Despite count = -1, Linux will only dispatch one packet at a time. */
       total += ret;
-   } while (ret != 0);
+
+#ifdef linux
+      /* keep looping until we've dispatched all the outstanding packets */
+      if (ret == 0) break;
+#else
+      /* we get them all on the first shot */
+      break;
+#endif
+   }
    /*FIXME*/fprintf(stderr, "%-20d\r", total);
 }
 
