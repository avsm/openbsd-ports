$OpenBSD: patch-gcc_c-pragma_c,v 1.1 2002/05/27 16:58:29 espie Exp $
--- gcc/c-pragma.c.orig	Sun Apr 28 20:43:53 2002
+++ gcc/c-pragma.c	Mon May 27 15:48:28 2002
@@ -284,9 +284,14 @@ apply_pragma_weak (decl, value)
      tree decl, value;
 {
   if (value)
-    decl_attributes (&decl, build_tree_list (get_identifier ("alias"),
-				             build_tree_list (NULL, value)),
-		     0);
+    {
+      value = build_string (IDENTIFIER_LENGTH (value),
+			    IDENTIFIER_POINTER (value));
+      decl_attributes (&decl, build_tree_list (get_identifier ("alias"),
+					       build_tree_list (NULL, value)),
+		       0);
+    }
+
   if (SUPPORTS_WEAK && DECL_EXTERNAL (decl) && TREE_USED (decl)
       && TREE_SYMBOL_REFERENCED (DECL_ASSEMBLER_NAME (decl)))
     warning_with_decl (decl, "applying #pragma weak `%s' after first use results in unspecified behavior");
@@ -343,7 +348,11 @@ handle_pragma_weak (dummy)
 
   decl = identifier_global_value (name);
   if (decl && TREE_CODE_CLASS (TREE_CODE (decl)) == 'd')
-    apply_pragma_weak (decl, value);
+    {
+      apply_pragma_weak (decl, value);
+      if (value)
+	assemble_alias (decl, value);
+    }
   else
     pending_weaks = tree_cons (name, value, pending_weaks);
 }
