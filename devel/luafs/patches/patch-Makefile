$OpenBSD: patch-Makefile,v 1.4 2006/09/24 16:56:08 pedro Exp $
--- Makefile.orig	Sun Sep 24 13:46:06 2006
+++ Makefile	Sun Sep 24 13:46:34 2006
@@ -8,14 +8,18 @@ include $(CONFIG)
 
 COMPAT_O= $(COMPAT_DIR)/compat-5.1.o
 SRCS= src/$T.c
-OBJS= src/$T.o $(COMPAT_O)
+OBJS= src/$T.o
 
+all: lib
 
 lib: src/$(LIBNAME)
 
 src/$(LIBNAME): $(OBJS)
-	export MACOSX_DEPLOYMENT_TARGET="10.3"; $(CC) $(CFLAGS) $(LIB_OPTION) -o src/$(LIBNAME) $(OBJS)
+	$(CC) $(CFLAGS) $(LIB_OPTION) lfs.o -o $(LIBNAME)
 
+$(OBJS): $(SRCS)
+	$(CC) $(CFLAGS) $(INCS) -c src/lfs.c
+
 $(COMPAT_O): $(COMPAT_DIR)/compat-5.1.c
 	$(CC) -c $(CFLAGS) -o $@ $(COMPAT_DIR)/compat-5.1.c
 
@@ -26,3 +30,9 @@ install: src/$(LIBNAME)
 
 clean:
 	rm -f src/$(LIBNAME) $(OBJS) $(COMPAT_O)
+
+regress:
+	@echo "Running test..."; \
+	LUA_CPATH="./?.so"; \
+	export LUA_CPATH; \
+	$(LUA) tests/test.lua
