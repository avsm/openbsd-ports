$OpenBSD: patch-src_lib-storage_index_mbox_mbox-storage_c,v 1.5 2008/05/28 23:08:03 sthen Exp $
--- src/lib-storage/index/mbox/mbox-storage.c.orig	Tue May 27 19:46:44 2008
+++ src/lib-storage/index/mbox/mbox-storage.c	Tue May 27 19:47:39 2008
@@ -4,6 +4,7 @@
 #include "ioloop.h"
 #include "buffer.h"
 #include "istream.h"
+#include "restrict-access.h"
 #include "home-expand.h"
 #include "mkdir-parents.h"
 #include "unlink-directory.h"
@@ -537,6 +538,12 @@ static int verify_inbox(struct index_storage *storage)
 
 	/* make sure inbox file itself exists */
 	fd = open(storage->inbox_path, O_RDWR | O_CREAT | O_EXCL, 0660);
+	if (fd == -1 && errno == EACCES) {
+		/* try again with increased privileges */
+		(void)restrict_access_use_priv_gid();
+		fd = open(storage->inbox_path, O_RDWR | O_CREAT | O_EXCL, 0660);
+		restrict_access_drop_priv_gid();
+	}
 	if (fd != -1)
 		(void)close(fd);
 	else if (errno == ENOTDIR &&
