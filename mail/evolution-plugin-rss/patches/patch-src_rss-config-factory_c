$OpenBSD: patch-src_rss-config-factory_c,v 1.3 2010/09/30 16:13:32 ajacoutot Exp $

From 37ebcebeae4e85024ef6689266a611841b58da2e Mon Sep 17 00:00:00 2001
From: Lucian Langa <lucilanga@gnome.org>
Date: Fri, 09 Jul 2010 14:38:06 +0000
Subject: adapt to GError camel modifications

--- src/rss-config-factory.c.orig	Tue Jul 20 22:32:03 2010
+++ src/rss-config-factory.c	Thu Sep 30 17:20:07 2010
@@ -976,7 +976,7 @@ destroy_delete(GtkWidget *selector, gpointer user_data
 //this function resembles emfu_delete_rec in mail/em-folder-utils.c
 //which is not exported ?
 static void
-rss_delete_rec (CamelStore *store, CamelFolderInfo *fi, CamelException *ex)
+rss_delete_rec (CamelStore *store, CamelFolderInfo *fi, GError **error)
 {
 	int i;
 	GPtrArray *uids;
@@ -986,7 +986,7 @@ rss_delete_rec (CamelStore *store, CamelFolderInfo *fi
 
 		d("deleting folder '%s'\n", fi->full_name);
 
-		if (!(folder = camel_store_get_folder (store, fi->full_name, 0, ex)))
+		if (!(folder = camel_store_get_folder (store, fi->full_name, 0, error)))
 			return;
 
 			uids = camel_folder_get_uids (folder);
@@ -1004,8 +1004,8 @@ rss_delete_rec (CamelStore *store, CamelFolderInfo *fi
 
 		d("do camel_store_delete_folder()\n");
 
-		camel_store_delete_folder (store, fi->full_name, ex);
-		if (camel_exception_is_set (ex))
+		camel_store_delete_folder (store, fi->full_name, error);
+		if (error != NULL)
 			return;
 
 		fi = fi->next;
@@ -1013,8 +1013,9 @@ rss_delete_rec (CamelStore *store, CamelFolderInfo *fi
 }
 
 void
-rss_delete_folders (
-	CamelStore *store, const char *full_name, CamelException *ex)
+rss_delete_folders (CamelStore *store,
+		const char *full_name,
+		GError **error)
 {
 	guint32 flags = CAMEL_STORE_FOLDER_INFO_RECURSIVE
 		| CAMEL_STORE_FOLDER_INFO_FAST
@@ -1025,12 +1026,12 @@ rss_delete_folders (
 	fi = camel_store_get_folder_info (
 		store,
 		full_name,
-		flags, ex);
-	if (!fi || camel_exception_is_set (ex))
+		flags, error);
+	if (!fi || error != NULL)
 		return;
 
 	d("call rss_delete_rec()\n");
-	rss_delete_rec (store, fi, ex);
+	rss_delete_rec (store, fi, error);
 	camel_store_free_folder_info (store, fi);
 }
 
@@ -1407,7 +1408,7 @@ process_dialog_edit(add_feed *feed, gchar *url, gchar 
 	gpointer key = lookup_key(feed_name);
 	gchar *prefix = NULL;
 	hrfeed *saved_feed;
-	CamelException ex;
+	GError *error = NULL;
 	CamelStore *store = rss_component_peek_local_store();
 	GtkWidget *msg_feeds, *progress;
 
@@ -1516,21 +1517,13 @@ process_dialog_edit(add_feed *feed, gchar *url, gchar 
 				gchar *b = g_build_path(
 						G_DIR_SEPARATOR_S,
 						dir, feed->feed_name, NULL);
-				camel_exception_init (&ex);
-				camel_store_rename_folder (store, a, b, &ex);
-				if (camel_exception_is_set (&ex)) {
-#if EVOLUTION_VERSION < 22904
-					e_error_run(GTK_WINDOW(
-						rf->preferences),
-						"mail:no-rename-folder",
-						a, b, ex.desc, NULL);
-#else
+				camel_store_rename_folder (store, a, b, &error);
+				if (error != NULL) {
 					e_alert_run_dialog_for_args(
 						GTK_WINDOW(rf->preferences),
 						"mail:no-rename-folder",
-						a, b, ex.desc, NULL);
-#endif
-					camel_exception_clear (&ex);
+						a, b, error->message, NULL);
+					g_clear_error(&error);
 				}
 				g_free(dir);
 				g_free(b);
