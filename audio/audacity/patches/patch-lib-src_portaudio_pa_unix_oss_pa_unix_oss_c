$OpenBSD: patch-lib-src_portaudio_pa_unix_oss_pa_unix_oss_c,v 1.2 2006/12/17 12:12:59 ajacoutot Exp $
--- lib-src/portaudio/pa_unix_oss/pa_unix_oss.c.orig	Sun Oct 29 01:05:50 2006
+++ lib-src/portaudio/pa_unix_oss/pa_unix_oss.c	Sat Dec  2 11:05:46 2006
@@ -45,7 +45,8 @@
 #elif defined(__FreeBSD__)
 #include <sys/soundcard.h>
 #else
-#include <machine/soundcard.h> /* JH20010905 */
+#include <soundcard.h> /* JH20010905 */
+#include <sys/audioio.h>
 #endif
 
 
@@ -219,11 +220,15 @@ error:
 }
 
 /*******************************************************************************************/
-PaError Pa_SetupDeviceFormat( int devHandle, int numChannels, int sampleRate )
+PaError Pa_SetupDeviceFormat( int devHandle, int numChannels, int sampleRate, int input )
 {
     PaError result = paNoError;
     int     tmp;
 
+#ifdef __OpenBSD__
+    audio_info_t audio_if;
+#endif
+
     /* Set format, channels, and rate in this order to keep OSS happy. */
     /* Set data format. FIXME - handle more native formats. */
     tmp = AFMT_S16_NE;
@@ -273,18 +278,52 @@ PaError Pa_SetupDeviceFormat( int devHan
            return paHostError;
         }
     }
+
+#ifdef __OpenBSD__
+
+    AUDIO_INITINFO(&audio_if);
+
+    switch(input) {
+    case 2:
+        audio_if.record.open = 1;
+        audio_if.record.pause = 0;
+        audio_if.play.open = 1;
+        audio_if.play.pause = 0;
+        break;
+
+    case 1:
+        audio_if.record.open = 1;
+        audio_if.record.pause = 0;
+        break;
+
+    case 0:
+        audio_if.play.open = 1;
+        audio_if.play.pause = 0;
+        break;
+
+    default:
+       break;
+    }
+
+    if (ioctl(devHandle, AUDIO_SETINFO, &audio_if) == -1)
+    {
+        ERR_RPT(("Pa_SetupDeviceFormat: could not AUDIO_SETINFO for recording on OpenBSD\n" ));
+        return paHostError;
+    }
+
+#endif
     
     return result;
 }
 
 PaError Pa_SetupOutputDeviceFormat( int devHandle, int numChannels, int sampleRate )
 {
-  return Pa_SetupDeviceFormat(devHandle, numChannels, sampleRate);
+  return Pa_SetupDeviceFormat(devHandle, numChannels, sampleRate, 0);
 }
 
 PaError Pa_SetupInputDeviceFormat( int devHandle, int numChannels, int sampleRate )
 {
-  return Pa_SetupDeviceFormat(devHandle, numChannels, sampleRate);
+  return Pa_SetupDeviceFormat(devHandle, numChannels, sampleRate, 1);
 }
 
 
