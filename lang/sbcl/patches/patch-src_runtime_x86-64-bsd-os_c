$OpenBSD: patch-src_runtime_x86-64-bsd-os_c,v 1.1 2010/08/24 12:20:30 jasper Exp $

Fix FP exceptions after src/sys/arch/amd64/amd64/machdep.c 1.110

--- src/runtime/x86-64-bsd-os.c.orig	Fri Nov 20 13:30:08 2009
+++ src/runtime/x86-64-bsd-os.c	Fri Jul 30 12:25:17 2010
@@ -8,6 +8,10 @@
 #include <machine/fpu.h>
 #endif
 
+#if defined(LISP_FEATURE_OPENBSD)
+#include <machine/fpu.h>
+#endif
+
 #ifdef LISP_FEATURE_MACH_EXCEPTION_HANDLER
 #include <mach/mach.h>
 
@@ -180,5 +184,18 @@ os_restore_fp_control(os_context_t *context)
     asm ("ldmxcsr %0" : : "m" (temp));
     /* same for x87 FPU. */
     asm ("fldcw %0" : : "m" (ex->en_cw));
+}
+#endif
+
+#if defined(LISP_FEATURE_OPENBSD)
+void
+os_restore_fp_control(os_context_t *context)
+{
+    if (context->sc_fpstate != NULL) {
+        u_int32_t mxcsr = context->sc_fpstate->fx_mxcsr & ~0x3F;
+        u_int16_t cw = context->sc_fpstate->fx_fcw;
+        asm ("ldmxcsr %0" : : "m" (mxcsr));
+        asm ("fldcw %0" : : "m" (cw));
+    }
 }
 #endif
