$OpenBSD: patch-gnome-panel_menu_c,v 1.5 2010/09/30 07:36:27 ajacoutot Exp $
--- gnome-panel/menu.c.orig	Wed Jun 23 01:42:54 2010
+++ gnome-panel/menu.c	Wed Sep 29 11:35:02 2010
@@ -25,6 +25,7 @@
 #include "menu.h"
 
 #include <string.h>
+#include <stdlib.h>
 
 #include <glib/gi18n.h>
 #include <gio/gio.h>
@@ -1792,8 +1793,16 @@ GtkWidget *
 create_main_menu (PanelWidget *panel)
 {
 	GtkWidget *main_menu;
+	gchar      *xdgMenuPrefix, *applicationsMenu;
 
-	main_menu = create_applications_menu ("applications.menu", NULL, TRUE);
+	/* Respect XDG_MENU_PREFIX */
+	setenv ("XDG_MENU_PREFIX", "gnome-", 0);
+
+	xdgMenuPrefix = getenv ("XDG_MENU_PREFIX");
+	applicationsMenu = g_strconcat (xdgMenuPrefix, "applications.menu", NULL);
+
+	main_menu = create_applications_menu (applicationsMenu, NULL, TRUE);
+	g_free (applicationsMenu);
 
 	g_object_set_data (G_OBJECT (main_menu), "menu_panel", panel);
 	/* FIXME need to update the panel on parent_set */
