$OpenBSD: patch-libtiff_tif_getimage_c,v 1.3 2005/03/27 06:13:07 brad Exp $
--- libtiff/tif_getimage.c.orig	Mon Dec 22 03:22:15 2003
+++ libtiff/tif_getimage.c	Sun Mar 27 00:30:27 2005
@@ -248,11 +248,11 @@ TIFFRGBAImageBegin(TIFFRGBAImage* img, T
     TIFFGetFieldDefaulted(tif, TIFFTAG_SAMPLESPERPIXEL, &img->samplesperpixel);
     TIFFGetFieldDefaulted(tif, TIFFTAG_EXTRASAMPLES,
 	&extrasamples, &sampleinfo);
-    if (extrasamples == 1)
+    if (extrasamples >= 1)
     {
 	switch (sampleinfo[0]) {
 	case EXTRASAMPLE_UNSPECIFIED:	/* Workaround for some images without */
-		if (img->samplesperpixel == 4)	/* correct info about alpha channel */
+		if (img->samplesperpixel > 3)	/* correct info about alpha channel */
 			img->alpha = EXTRASAMPLE_ASSOCALPHA;
 		break;
 	case EXTRASAMPLE_ASSOCALPHA:	/* data is pre-multiplied */
@@ -565,6 +565,7 @@ gtTileContig(TIFFRGBAImage* img, uint32*
 	TIFFError(TIFFFileName(tif), "No space for tile buffer");
 	return (0);
     }
+    _TIFFmemset(buf, 0, TIFFTileSize(tif));
     TIFFGetField(tif, TIFFTAG_TILEWIDTH, &tw);
     TIFFGetField(tif, TIFFTAG_TILELENGTH, &th);
 
@@ -664,6 +665,7 @@ gtTileSeparate(TIFFRGBAImage* img, uint3
 	TIFFError(TIFFFileName(tif), "No space for tile buffer");
 	return (0);
     }
+    _TIFFmemset(buf, 0, 4*tilesize);
     r = buf;
     g = r + tilesize;
     b = g + tilesize;
@@ -727,9 +729,7 @@ gtTileSeparate(TIFFRGBAImage* img, uint3
                 (*put)(img, raster+y*w+col, col, y,
                        npix, nrow, fromskew, toskew + fromskew, 
                        r + pos, g + pos, b + pos, a + pos);
-            } 
-            else 
-            {
+            } else {
                 (*put)(img, raster+y*w+col, col, y,
                        tw, nrow, 0, toskew, r + pos, g + pos, b + pos, a + pos);
             }
@@ -783,13 +783,13 @@ gtStripContig(TIFFRGBAImage* img, uint32
 	TIFFError(TIFFFileName(tif), "No space for strip buffer");
 	return (0);
     }
+    _TIFFmemset(buf, 0, TIFFStripSize(tif));
 
     flip = setorientation(img);
     if (flip & FLIP_VERTICALLY) {
 	    y = h - 1;
 	    toskew = -(int32)(w + w);
-    }
-    else {
+    } else {
 	    y = 0;
 	    toskew = -(int32)(w - w);
     }
@@ -865,6 +865,7 @@ gtStripSeparate(TIFFRGBAImage* img, uint
 	TIFFError(TIFFFileName(tif), "No space for tile buffer");
 	return (0);
     }
+    _TIFFmemset(buf, 0, 4*stripsize);
     g = r + stripsize;
     b = g + stripsize;
     a = b + stripsize;
