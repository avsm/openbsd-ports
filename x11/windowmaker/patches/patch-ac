--- libPropList/filehandling.c.orig	Sat Oct 17 15:58:37 1998
+++ libPropList/filehandling.c	Fri Dec 25 15:04:44 1998
@@ -17,6 +17,10 @@
 #include <string.h>
 #include <unistd.h>
 
+#ifdef HAVE_MKSTEMP
+#	include <limits.h>
+#endif
+
 #define pl_scan_string(c) yy_scan_string(c)
 #define plparse() yyparse()
 #define pl_delete_buffer(b) yy_delete_buffer(b)
@@ -345,22 +349,34 @@
 
 BOOL PLSave(proplist_t pl, BOOL atomically)
 {
+#ifdef HAVE_MKSTEMP
+  char theFileName[ PATH_MAX+1 ] = "\0";
+  const char *tempmask = ".XXXXXXXXXX";
+#else
   const char *theFileName;
-  const char *theRealFileName = NULL;
   char tmp_fileName[255];
   char tmp_realFileName[255];
   char dirname[255];
   char *tmp_dirname, *tmp2_dirname;
   char *basename, *tmp_basename;
+#endif
+  const char *theRealFileName = NULL;
   FILE *theFile;
   int c;
   char *desc = NULL;
   
   theRealFileName = PLGetString(PLGetFilename(pl));
   if(!theRealFileName) return NO;
-  
+
   if (atomically)
     {
+#ifdef HAVE_MKSTEMP 
+       if (strlen( theRealFileName )+strlen( tempmask ) > PATH_MAX)
+         goto failure;  /* path too long to create temporary file */
+       strncpy( theFileName, theRealFileName, PATH_MAX );
+       strncat( theFileName, tempmask, PATH_MAX - strlen( theFileName ) );
+       theFile = fdopen( mkstemp( theFileName ), "w" );	
+#else
       theFileName = tmpnam(NULL);
       strcpy(tmp_fileName, theFileName);
 
@@ -389,14 +405,21 @@
 	} 
       
       theFileName = strcat(dirname, basename);
+#endif
     } 
   else
     { 
+#ifdef HAVE_MKSTEMP
+      theFile = fopen( theRealFileName, "w" );
+#else
       theFileName = theRealFileName;
+#endif
     } 
 
+#ifndef HAVE_MKSTEMP
   /* Open the file (whether temp or real) for writing. */
   theFile = fopen(theFileName, "w");
+#endif
 
   if (theFile == NULL)          /* Something went wrong; we weren't
                                  * even able to open the file. */
