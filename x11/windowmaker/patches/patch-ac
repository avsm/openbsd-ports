--- libPropList/filehandling.c.orig	Sat Oct 17 15:58:37 1998
+++ libPropList/filehandling.c	Sat Dec 19 23:04:09 1998
@@ -16,6 +16,7 @@
 #include <stdlib.h>
 #include <string.h>
 #include <unistd.h>
+#include <limits.h>
 
 #define pl_scan_string(c) yy_scan_string(c)
 #define plparse() yyparse()
@@ -345,58 +346,30 @@
 
 BOOL PLSave(proplist_t pl, BOOL atomically)
 {
-  const char *theFileName;
+  char theFileName[ PATH_MAX+1 ] = "\0";
+  const char *tempmask = ".XXXXXXXXXX";
   const char *theRealFileName = NULL;
-  char tmp_fileName[255];
-  char tmp_realFileName[255];
-  char dirname[255];
-  char *tmp_dirname, *tmp2_dirname;
-  char *basename, *tmp_basename;
-  FILE *theFile;
+  FILE *theFile = NULL;
   int c;
   char *desc = NULL;
   
   theRealFileName = PLGetString(PLGetFilename(pl));
+
   if(!theRealFileName) return NO;
   
+  /* Open the file (whether temp or real) for writing. */
   if (atomically)
     {
-      theFileName = tmpnam(NULL);
-      strcpy(tmp_fileName, theFileName);
-
-      if((tmp_basename=strtok(tmp_fileName, "/")))
-	do
-	  basename=tmp_basename;
-	while((tmp_basename=strtok(NULL, "/")));
-      else
-	basename=(char *)theFileName;
-	
-      strcpy(tmp_realFileName, theRealFileName);
-      dirname[0]='\0';
-
-      if((tmp_dirname=strtok(tmp_realFileName, "/")))
- 	{
-	  if(theRealFileName[0]=='/')
-	    strcat(dirname, "/");
-	  tmp2_dirname = strtok(NULL, "/");
-	  while((tmp2_dirname)) 
-	    { 
-	      strcat(dirname, tmp_dirname); 
-	      strcat(dirname, "/"); 
-	      tmp_dirname = tmp2_dirname; 
-	      tmp2_dirname = strtok(NULL, "/"); 
-	    } 
-	} 
-      
-      theFileName = strcat(dirname, basename);
+       if (strlen( theRealFileName )+strlen( tempmask ) > PATH_MAX)
+         goto failure;  /* path too long to create temporary file */
+       strncpy( theFileName, theRealFileName, PATH_MAX );
+       strncpy( theFileName, tempmask, PATH_MAX - strlen( theRealFileName ) );
+       theFile = fdopen( mkstemp( theFileName ), "w" );	
     } 
   else
     { 
-      theFileName = theRealFileName;
+       theFile = fopen( theRealFileName, "w" );
     } 
-
-  /* Open the file (whether temp or real) for writing. */
-  theFile = fopen(theFileName, "w");
 
   if (theFile == NULL)          /* Something went wrong; we weren't
                                  * even able to open the file. */

