$OpenBSD: patch-src_ck-sysdeps-unix_c,v 1.6 2010/07/01 07:50:59 ajacoutot Exp $
--- src/ck-sysdeps-unix.c.orig	Wed Apr 29 21:07:29 2009
+++ src/ck-sysdeps-unix.c	Thu Jul  1 00:35:56 2010
@@ -35,6 +35,10 @@
 #include <linux/kd.h>
 #endif
 
+#if defined(__OpenBSD__)
+#include <dev/wscons/wsdisplay_usl_io.h>
+#endif
+
 #ifdef HAVE_SYS_VT_H
 #include <sys/vt.h>
 #endif
@@ -69,7 +73,11 @@ ck_get_socket_peer_credentials   (int      socket_fd,
         ret = FALSE;
 
 #ifdef SO_PEERCRED
-        struct ucred cr;
+#ifndef __OpenBSD__
+        struct uncred cr;
+#else
+	struct sockpeercred cr;
+#endif
         socklen_t    cr_len;
 
         cr_len = sizeof (cr);
@@ -126,7 +134,7 @@ ck_get_socket_peer_credentials   (int      socket_fd,
 gboolean
 ck_fd_is_a_console (int fd)
 {
-#ifdef __linux__
+#if defined(__linux__) || defined(__OpenBSD__)
         struct vt_stat vts;
 #elif defined(__FreeBSD__)
         int vers;
@@ -134,7 +142,7 @@ ck_fd_is_a_console (int fd)
         int  kb_ok;
 
         errno = 0;
-#ifdef __linux__
+#if defined(__linux__) || defined(__OpenBSD__)
         kb_ok = (ioctl (fd, VT_GETSTATE, &vts) == 0);
 #elif defined(__FreeBSD__)
         kb_ok = (ioctl (fd, CONS_GETVERS, &vers) == 0);
@@ -184,6 +192,13 @@ ck_get_a_console_fd (void)
         }
 #endif
 
+#if defined(__OpenBSD__)
+	fd = open_a_console ("/dev/ttyC0");
+	if (fd >= 0) {
+		goto done;
+	}
+#endif
+
 #ifdef _PATH_TTY
         fd = open_a_console (_PATH_TTY);
         if (fd >= 0) {
@@ -261,7 +276,8 @@ ck_wait_for_active_console_num (int   console_fd,
         ret = FALSE;
 
         errno = 0;
-#ifdef VT_WAITACTIVE
+// XXX hangs forever, pthread bug (works with rthreads)
+#if defined VT_WAITACTIVE && !defined (__OpenBSD__)
         g_debug ("VT_WAITACTIVE for vt %d", num);
         res = ioctl (console_fd, VT_WAITACTIVE, num);
         g_debug ("VT_WAITACTIVE for vt %d returned %d", num, res);
