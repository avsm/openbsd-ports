$OpenBSD: patch-smbd_service_c,v 1.1.2.1 2006/08/11 04:16:27 sturm Exp $
--- smbd/service.c.orig	Thu Aug 10 08:33:49 2006
+++ smbd/service.c	Thu Aug 10 08:35:14 2006
@@ -723,6 +723,11 @@ connection_struct *make_connection(const
 		smb_panic("make_connection: PANIC ERROR. Called as nonroot\n");
 	}
 
+	if (conn_num_open() > 2047) {
+		*status = NT_STATUS_INSUFF_SERVER_RESOURCES;
+		return NULL;
+	}
+
 	if(lp_security() != SEC_SHARE) {
 		vuser = get_valid_user_struct(vuid);
 		if (!vuser) {
