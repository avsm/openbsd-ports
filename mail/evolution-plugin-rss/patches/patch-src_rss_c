$OpenBSD: patch-src_rss_c,v 1.5 2010/09/30 16:13:32 ajacoutot Exp $

From 37ebcebeae4e85024ef6689266a611841b58da2e Mon Sep 17 00:00:00 2001
From: Lucian Langa <lucilanga@gnome.org>
Date: Fri, 09 Jul 2010 14:38:06 +0000
Subject: adapt to GError camel modifications

--- src/rss.c.orig	Tue Jul 20 22:32:03 2010
+++ src/rss.c	Thu Sep 30 17:20:07 2010
@@ -492,7 +492,7 @@ browser_stream_write(CamelStream *stream, gchar *base)
 	GString *str = g_string_new(NULL);
 	gchar *line;
 	CamelStream *in = camel_stream_buffer_new(stream, CAMEL_STREAM_BUFFER_READ);
-	while ((line = camel_stream_buffer_read_line((CamelStreamBuffer *)in))) {
+	while ((line = camel_stream_buffer_read_line((CamelStreamBuffer *)in, NULL))) {
 		gchar *tmp = line;
 		g_string_append(str, line);
 		g_free(tmp);
@@ -1101,7 +1101,7 @@ rss_browser_update_content (
 						d("cache read\n");
 						fi->create = 0;
 						browser_stream_write(stream, po->website);
-						camel_stream_close(stream);
+						camel_stream_close(stream, NULL);
 #if (DATASERVER_VERSION >= 2031001)
 						g_object_unref(stream);
 #else
@@ -1149,13 +1149,16 @@ webkit_set_preferences(void)
 	g_object_set (settings, "enable-page-cache", TRUE, NULL);
 	//g_object_set (settings, "auto-resize-window", TRUE, NULL);
 	g_object_set (settings, "enable-plugins",
-		gconf_client_get_bool(rss_gconf, GCONF_KEY_EMBED_PLUGIN, NULL),
+		gconf_client_get_bool(rss_gconf,
+			GCONF_KEY_EMBED_PLUGIN, NULL),
 		NULL);
 	g_object_set (settings, "enable-java-applet",
-		gconf_client_get_bool(rss_gconf, GCONF_KEY_HTML_JAVA, NULL),
+		gconf_client_get_bool(rss_gconf,
+			GCONF_KEY_HTML_JAVA, NULL),
 		NULL);
 	g_object_set (settings, "enable-scripts",
-		gconf_client_get_bool(rss_gconf, GCONF_KEY_HTML_JS, NULL),
+		gconf_client_get_bool(rss_gconf,
+			GCONF_KEY_HTML_JS, NULL),
 		NULL);
 #endif
 	webkit_web_view_set_full_content_zoom(
@@ -2289,7 +2292,8 @@ void org_gnome_cooly_format_rss(void *ep, EMFormatHook
 #endif
 		camel_data_wrapper_write_to_stream(
 			mcontent,
-			(CamelStream *)stream);
+			(CamelStream *)stream,
+			NULL);
 		g_byte_array_append (buffer, (unsigned char *)"", 1);
 //#ifdef EVOLUTION_2_12	//aparently this ("?" char parsing) is fixed in 2.12
 //		//then again this does not work in evo > 2.12 perhaps is gtkhtml related
@@ -2485,7 +2489,7 @@ render_body:	if (category)
 	}
 
 	//this is required for proper charset rendering when html
-	camel_data_wrapper_construct_from_stream(dw, fstream);
+	camel_data_wrapper_construct_from_stream(dw, fstream, NULL);
 #if EVOLUTION_VERSION >= 23100
 	camel_medium_set_content((CamelMedium *)part, dw);
 #else
@@ -3634,7 +3638,7 @@ finish_website (SoupSession *soup_sess, SoupMessage *m
 		g_free(tmsg);
 		if (ub->create) {
 			//stream remove
-			camel_stream_close(ub->stream);
+			camel_stream_close(ub->stream, NULL);
 #if (DATASERVER_VERSION >= 2031001)
 			g_object_unref(ub->stream);
 #else
@@ -3643,8 +3647,8 @@ finish_website (SoupSession *soup_sess, SoupMessage *m
 		}
 	} else {
 		if (ub->create) {
-			camel_stream_write(ub->stream, response->str, strlen(response->str));
-			camel_stream_close(ub->stream);
+			camel_stream_write(ub->stream, response->str, strlen(response->str), NULL);
+			camel_stream_close(ub->stream, NULL);
 #if (DATASERVER_VERSION >= 2031001)
 			g_object_unref(ub->stream);
 #else
@@ -4102,7 +4106,7 @@ check_feed_folder(gchar *folder_name)
 void
 rss_delete_feed(gchar *full_path, gboolean folder)
 {
-	CamelException ex;
+	GError *error = NULL;
 	gchar *tmp, *tkey, *url;
 	CamelStore *store;
 	gchar *name, *real_name, *buf, *feed_dir, *feed_name;
@@ -4115,24 +4119,15 @@ rss_delete_feed(gchar *full_path, gboolean folder)
 	real_name = g_hash_table_lookup(rf->feed_folders, name);
 	if (!real_name)
 		real_name = name;
-	camel_exception_init (&ex);
-	rss_delete_folders (store, full_path, &ex);
-	if (camel_exception_is_set (&ex)) {
-#if EVOLUTION_VERSION < 22904
-		e_error_run(NULL,
-			"mail:no-delete-folder",
-			full_path,
-			ex.desc,
-			NULL);
-#else
+	rss_delete_folders (store, full_path, &error);
+	if (error != NULL) {
 		e_alert_run_dialog_for_args(
 			e_shell_get_active_window (NULL),
 			"mail:no-delete-folder",
 			full_path,
-			ex.desc,
+			error->message,
 			NULL);
-#endif
-		camel_exception_clear (&ex);
+		g_clear_error(&error);
 	}
 	//also remove status file
 	tkey = g_hash_table_lookup(rf->hrname,
@@ -4558,7 +4553,6 @@ void org_gnome_cooly_rss_startup(void *ep, ESEventTarg
 void
 check_folders(void)
 {
-	CamelException ex;
 	CamelStore *store = rss_component_peek_local_store();
 	CamelFolder *mail_folder, *old_folder;
 
@@ -4573,7 +4567,7 @@ check_folders(void)
 	} else if (mail_folder == NULL) {
 		camel_store_create_folder (
 			store, NULL,
-			lookup_main_folder(), &ex);
+			lookup_main_folder(), NULL);
 		return;
 	}
 #if (DATASERVER_VERSION >= 2031001)
@@ -5100,7 +5094,6 @@ create_mail(create_feed *CF)
 	CamelMimeMessage *new = camel_mime_message_new();
 	CamelInternetAddress *addr;
 	CamelMessageInfo *info;
-	CamelException *ex = NULL;
 	struct tm tm;
 	time_t time, actual_time;
 	CamelDataWrapper *rtext;
@@ -5220,7 +5213,7 @@ create_mail(create_feed *CF)
 	stream = camel_stream_mem_new ();
 	// w/out an format argument this throws and seg fault
 	camel_stream_printf (stream, "%s", CF->body);
-	camel_data_wrapper_construct_from_stream (rtext, stream);
+	camel_data_wrapper_construct_from_stream (rtext, stream, NULL);
 #if (DATASERVER_VERSION >= 2031001)
 	g_object_unref (stream);
 #else
@@ -5311,7 +5304,7 @@ create_mail(create_feed *CF)
 		camel_medium_set_content_object(CAMEL_MEDIUM(new), CAMEL_DATA_WRAPPER(rtext));
 #endif
 
-	camel_folder_append_message(mail_folder, new, info, &appended_uid, ex);
+	camel_folder_append_message(mail_folder, new, info, &appended_uid, NULL);
 
 	/* no point in filtering mails at import time as it just
 	 * wastes time, user can setup his own afterwards
@@ -5372,12 +5365,13 @@ file_to_message(const char *filename)
 	file = (CamelStreamFs *)
 			camel_stream_fs_new_with_name(filename,
 				O_RDWR|O_CREAT,
-				0666);
+				0666,
+				NULL);
 
 	if (!file)
 		return NULL;
 
-	camel_data_wrapper_construct_from_stream(content, (CamelStream *)file);
+	camel_data_wrapper_construct_from_stream(content, (CamelStream *)file, NULL);
 #if (DATASERVER_VERSION >= 2031001)
 	g_object_unref((CamelObject *)file);
 #else
