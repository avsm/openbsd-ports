# $OpenBSD: Makefile,v 1.18 2003/06/13 04:17:12 brad Exp $

COMMENT=		"GNU development tools"

DISTNAME=		binutils-2.13.2.1
CATEGORIES=		devel
MASTER_SITES=		${MASTER_SITE_GNU:=binutils/}

# GPL
PERMIT_PACKAGE_CDROM=	Yes
PERMIT_PACKAGE_FTP=	Yes
PERMIT_DISTFILES_CDROM=	Yes
PERMIT_DISTFILES_FTP=	Yes

MAINTAINER=		Federico G. Schwindt <fgsch@openbsd.org>

HOMEPAGE=		http://sources.redhat.com/binutils/

AUTOCONF_VERSION=	2.13
BUILD_DEPENDS=		::devel/automake \
			${MODGNU_AUTOCONF_DEPENDS}

SUBST_VARS=		TARGET_ARCH OSREV

MODULES=		gnu
CONFIGURE_STYLE=	simple
CONFIGURE_ARGS=		--with-prefix=${PREFIX} \
			--disable-nls --disable-commonbfdlib

# cross-tools
FLAVORS=		alpha hppa i386 m68k m88k mips powerpc sparc \
			sparc64 vax
FLAVOR?=

# XXX: special handling needed for powerpc arch's and bootstraping
.if !empty(FLAVOR:L) && ${FLAVOR:L} != ${MACHINE_ARCH}
CONFIGURE_ARGS+=	--target=${FLAVOR:L}-unknown-openbsd${OSREV}
TARGET_ARCH=		${FLAVOR:L}
PLIST=			${PKGDIR}/PLIST.cross
.else
TARGET_ARCH=		${MACHINE_ARCH}
.endif

TARGET_DIR=		$${PREFIX}/${TARGET_ARCH}-unknown-openbsd${OSREV}

REGRESS_TARGET=		check
REGRESS_DEPENDS=	::devel/dejagnu

FILES=			ar nm-new objdump ranlib size strings strip-new 

post-extract:
	@cp -f ${FILESDIR}/{i386obsd.sh,sparcobsd.sh,m68kobsd.sh} \
		${WRKSRC}/ld/emulparams
	@cp -f ${FILESDIR}/te-obsd.h ${WRKSRC}/gas/config

post-patch:
	@cd ${WRKSRC}/bfd && AUTOCONF_VERSION=${AUTOCONF_VERSION} autoconf
	@-cd ${WRKSRC}/gas && { automake; AUTOCONF_VERSION=${AUTOCONF_VERSION} autoconf; }
	@cd ${WRKSRC}/ld && automake

do-install:
	${INSTALL_DATA_DIR} ${TARGET_DIR}/bin
	${INSTALL_DATA_DIR} ${TARGET_DIR}/man/man1
	if [ -f ${WRKSRC}/gprof/gprof ]; then \
	  cd ${WRKSRC};  \
	     ${INSTALL_PROGRAM} gprof/gprof ${TARGET_DIR}/bin; \
	     ${INSTALL_MAN} gprof/gprof.1 ${TARGET_DIR}/man/man1; \
	fi
	cd ${WRKSRC} && {						\
	    ${INSTALL_PROGRAM} gas/as-new ${TARGET_DIR}/bin/as;		\
	    ${INSTALL_PROGRAM} ld/ld-new ${TARGET_DIR}/bin/ld;		\
	    ${INSTALL_MAN} gas/doc/as.1 ${TARGET_DIR}/man/man1;		\
	    ${INSTALL_MAN} ld/ld.1 ${TARGET_DIR}/man/man1;		\
	    for s in ${FILES}; do					\
		d=`echo $${s} | sed s/-new//`;				\
		${INSTALL_PROGRAM} binutils/$${s} ${TARGET_DIR}/bin/$${d}; \
		${INSTALL_MAN} binutils/doc/$${d}.1 ${TARGET_DIR}/man/man1; \
	    done							\
	}

.include <bsd.port.mk>
