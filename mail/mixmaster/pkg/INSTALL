#!/bin/sh

# $OpenBSD: INSTALL,v 1.5 2003/06/22 10:05:29 sturm Exp $
#
#      Mixmaster installation script, using many ideas from
#      Adam Shostack's Install-Mix.

# use a sane path and install prefix
PATH=/bin:/usr/bin:/sbin:/usr/sbin
PREFIX=${PKG_PREFIX:-/usr/local}
MIXMASTER_BIN=${PREFIX}/sbin/mixmaster
MIXDIR=${PREFIX}/share/examples/mixmaster
MIXDEST=${SYSCONFDIR}/mixmaster
MIXSPOOL=/var/spool/mixmaster

MM=_mixmaster
ID=505

# verify proper execution
#
if [ $# -ne 2 ]; then
    echo "usage: $0 distname { PRE-INSTALL | POST-INSTALL }" >&2
    exit 1
fi

# Function: set up mixmaster user account.
#
do_accts()
{
    groupinfo -e $MM
    if [ $? -eq 0 ]; then
        echo "===>  Using existing group '$MM'"
    else
        echo "===>  Creating group '$MM'"
        groupadd -g $ID $MM
    fi

    userinfo -e $MM
    if [ $? -eq 0 ]; then
        echo "===>  Using existing account '$MM'"
    else
        echo "===>  Creating user '$MM'"
        useradd \
            -g $MM\
            -c "Anonymous Remailer" \
            -m -d $MIXDEST \
            -s /sbin/nologin \
            -u $ID $MM
    fi
}

last_message() 
{

echo "| Installation of mixmaster client complete."
echo "|"
echo "| The binary is suid '$MM' and can only be executed by members of"
echo "| the group '$MM'. Add all users to that group, that are allowed"
echo "| sending anonymous mail via the mixmaster network."
echo "+---------------"
echo "| WARNING!"
echo "|"
echo "| This port has changed its user/group from 'mixmaster' to '_mixmaster'."
echo "| If you installed this port before, ensure all permissions are set"
echo "| correctly and then \"rmuser mixmaster\"."
echo "+---------------"
echo ""

exit 0
}

# install client config files
do_install()
{
echo ""
echo "+---------------"
if [ ! -d $MIXDEST ]
then
  install -d -o $MM -g $MM -m 0710 $MIXDEST
elif [ -f $MIXDEST/mix.cfg ]
then
  echo "| $MIXDEST/mix.cfg does already exist. It will not be updated"
  echo "| by this script. If this is not your intention, please deinstall"
  echo "| mixmaster, delete $MIXDEST and reinstall."
  echo "|"
  last_message
fi

if [ ! -d $MIXDEST ]
then
  echo "Cannot create $MIXDEST"
  exit 1
fi

cd $MIXDIR
for i in "mix.cfg mlist.txt pubring.mix *.blk"
do
  install -o $MM -g $MM -m 0640 $i $MIXDEST
done

if [ ! -d $MIXSPOOL ]
then
  install -d -o $MM -g $MM -m 0770 $MIXSPOOL
fi

last_message
}

# Verify/process the command
#
case $2 in
    PRE-INSTALL)
        do_accts
        exit 0
        ;;
    POST-INSTALL)
        : install config files, see below
        chown $MM:$MM $MIXMASTER_BIN
        chmod 4550 $MIXMASTER_BIN
        do_install
        exit 0
        ;;
    *)
        echo "usage: $0 distname { PRE-INSTALL | POST-INSTALL }" >&2
        exit 1
        ;;
esac
