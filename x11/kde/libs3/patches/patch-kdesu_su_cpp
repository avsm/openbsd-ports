$OpenBSD: patch-kdesu_su_cpp,v 1.8 2006/06/03 12:47:30 espie Exp $
--- kdesu/su.cpp.orig	Mon May 22 20:14:18 2006
+++ kdesu/su.cpp	Sun May 28 13:22:11 2006
@@ -41,19 +41,35 @@
 #ifndef __PATH_SU
 #define __PATH_SU "false"
 #endif
+#ifndef __PATH_SUDO
+#define __PATH_SUDO "false"
+#endif
 
+class SuProcess::SuProcessPrivate
+{
+public:
+    bool m_useSudo;
+};
 
 SuProcess::SuProcess(const QCString &user, const QCString &command)
 {
     m_User = user;
     m_Command = command;
+    d = new SuProcess::SuProcessPrivate();
+    d->m_useSudo = false;
 }
 
 
 SuProcess::~SuProcess()
 {
+    delete d;
 }
 
+void SuProcess::setUseSudo(bool use_sudo)
+{
+    d->m_useSudo = use_sudo;
+}
+
 int SuProcess::checkInstall(const char *password)
 {
     return exec(password, Install);
@@ -65,7 +81,7 @@ int SuProcess::checkNeedPassword()
 }
 
 /*
-* Execute a command with su(1).
+* Execute a command with su(1) or sudo
 */
 
 int SuProcess::exec(const char *password, int check)
@@ -80,12 +96,20 @@ int SuProcess::exec(const char *password
     args += "staff";
 #endif
 
+    if (d->m_useSudo)
+    {
+	args += "-S";
+	args += "-p";
+	args += "Password:";
+	args += "-u";
+    }
     if ((m_Scheduler != SchedNormal) || (m_Priority > 50))
         args += "root";
     else
         args += m_User;
     
-    args += "-c";
+    if (!d->m_useSudo)
+	args += "-c";
     args += QCString(__KDE_BINDIR) + "/kdesu_stub";
 #ifndef Q_OS_DARWIN
     args += "-";
@@ -100,7 +124,7 @@ int SuProcess::exec(const char *password
     }
 
     // kdDebug(900) << k_lineinfo << "Call StubProcess::exec()" << endl;
-    if (StubProcess::exec(command, args) < 0)
+    if (StubProcess::exec(d->m_useSudo ? __PATH_SUDO : __PATH_SU, args) < 0)
     {
         return check ? SuNotFound : -1;
     }
@@ -112,7 +136,8 @@ int SuProcess::exec(const char *password
     if (ret == error) 
     {
         if (!check)
-            kdError(900) << k_lineinfo << "Conversation with su failed\n";
+	    kdError(900) << k_lineinfo << "Conversation with " <<
+		(d->m_useSudo ? "sudo" : "su") << " failed\n";
         return ret;
     }
     if (check == NeedPassword)
@@ -218,6 +243,9 @@ int SuProcess::ConverseSU(const char *pa
                     kdDebug(900) << k_lineinfo << "Read line <" << more << ">" << endl;
                 }
     
+       	        if (d->m_useSudo && line != "Password:")
+ 		    break;
+ 
                 // Match "Password: " with the regex ^[^:]+:[\w]*$.
                 const uint len = line.length();
                 for (i=0,j=0,colon=0; i<len; i++) 
@@ -272,6 +300,9 @@ int SuProcess::ConverseSU(const char *pa
             }
             //////////////////////////////////////////////////////////////////////////
             case HandleStub:
+		if (d->m_useSudo && line == "Password:")
+		    return -1;
+ 
                 // Read till we get "kdesu_stub"
                 if (line == "kdesu_stub")
                 {
