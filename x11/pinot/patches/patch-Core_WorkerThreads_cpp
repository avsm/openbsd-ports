$OpenBSD: patch-Core_WorkerThreads_cpp,v 1.1.1.1 2009/08/17 14:34:07 ajacoutot Exp $
--- Core/WorkerThreads.cpp.orig	Sat Jun 20 19:15:20 2009
+++ Core/WorkerThreads.cpp	Fri Jul 31 13:50:19 2009
@@ -34,6 +34,11 @@
 #include <glibmm/convert.h>
 #include <glibmm/exception.h>
 
+#ifdef __OpenBSD__
+#include <sys/param.h>
+#include <sys/sysctl.h>
+#endif
+
 #include "config.h"
 #include "NLS.h"
 #include "Languages.h"
@@ -285,8 +290,19 @@ ThreadsManager::ThreadsManager(const string &defaultIn
 	pthread_rwlock_init(&m_threadsLock, NULL);
 	pthread_rwlock_init(&m_listsLock, NULL);
 
-#ifdef HAVE_SYSCONF
+#if (defined HAVE_SYSCONF && ! defined __OpenBSD__)
 	m_numCPUs = sysconf(_SC_NPROCESSORS_ONLN);
+#elif defined __OpenBSD__
+	int mib[2], ncpus;
+	size_t len;
+	mib[0] = CTL_HW;
+	mib[1] = HW_NCPU;
+	len = sizeof(ncpus);
+	if (sysctl(mib, 2, &ncpus, &len, NULL, 0) > 0) {
+	    m_numCPUs = ncpus;
+	} else {
+	    m_numCPUs = 1;
+	}
 #endif
 }
 
