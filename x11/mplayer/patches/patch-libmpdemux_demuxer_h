$OpenBSD: patch-libmpdemux_demuxer_h,v 1.2 2006/02/23 11:34:54 biorn Exp $
--- libmpdemux/demuxer.h.orig	Sun Apr  3 16:08:26 2005
+++ libmpdemux/demuxer.h	Wed Feb 22 13:25:21 2006
@@ -155,17 +155,19 @@ inline static demux_packet_t* new_demux_
   dp->flags=0;
   dp->refcount=1;
   dp->master=NULL;
-  dp->buffer=len?(unsigned char*)malloc(len+8):NULL;
-  if(len) memset(dp->buffer+len,0,8);
+  dp->buffer=NULL;
+  if (len > 0 && (dp->buffer = (unsigned char *)malloc(len + 8)))
+    memset(dp->buffer + len, 0, 8);
+  else
+    dp->len = 0;
   return dp;
 }
 
 inline static void resize_demux_packet(demux_packet_t* dp, int len)
 {
-  if(len)
+  if(len > 0)
   {
      dp->buffer=(unsigned char *)realloc(dp->buffer,len+8);
-     memset(dp->buffer+len,0,8);
   }
   else
   {
@@ -173,6 +175,10 @@ inline static void resize_demux_packet(d
      dp->buffer=NULL;
   }
   dp->len=len;
+  if (dp->buffer)
+     memset(dp->buffer + len, 0, 8);
+  else
+     dp->len = 0;
 }
 
 inline static demux_packet_t* clone_demux_packet(demux_packet_t* pack){
