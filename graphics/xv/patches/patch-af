$OpenBSD: patch-af,v 1.2.26.1 2005/03/15 22:18:44 robert Exp $
--- xv.c.orig	Tue Mar 15 22:46:29 2005
+++ xv.c	Tue Mar 15 22:47:06 2005
@@ -1990,10 +1990,9 @@
 #else /* it is VMS */
       sprintf(filename, "[]xvXXXXXX");
 #endif
-      mktemp(filename);
+      fp = fdopen(mkstemp(filename), "w");
 
       clearerr(stdin);
-      fp = fopen(filename,"w");
       if (!fp) FatalError("openPic(): can't write temporary file");
     
       while ( (i=getchar()) != EOF) putc(i,fp);
@@ -2219,7 +2218,7 @@
   SetISTR(ISTR_INFO,formatStr);
 	
   SetInfoMode(INF_PART);
-  SetISTR(ISTR_FILENAME, 
+  SetISTR(ISTR_FILENAME, "%s",
 	  (filenum==DFLTPIC || filenum==GRABBED || frompipe)
 	  ? "<none>" : basefname);
 
@@ -2759,7 +2758,7 @@
   
 #ifndef VMS
   sprintf(uncompname, "%s/xvuXXXXXX", tmpdir);
-  mktemp(uncompname);
+  close(mkstemp(uncompname));
   sprintf(buf,"%s -c %s >%s", UNCOMPRESS, fname, uncompname);
 #else /* it IS VMS */
   strcpy(uncompname, "[]xvuXXXXXX");
@@ -2934,8 +2933,8 @@
   if (!cmd || (strlen(cmd) < (size_t) 2)) return 1;
 
   sprintf(tmpname,"%s/xvXXXXXX", tmpdir);
-  mktemp(tmpname);
-  if (tmpname[0] == '\0') {   /* mktemp() blew up */
+  close(mkstemp(tmpname));
+  if (tmpname[0] == '\0') {   /* mkstemp() blew up */
     sprintf(str,"Unable to create temporary filename.");
     ErrPopUp(str, "\nHow unlikely!");
     return 1;
@@ -3232,9 +3231,17 @@
   hints.flags = 0;
   if ((i&XValue || i&YValue)) hints.flags = USPosition;
 
-  if (i&XValue && i&XNegative) x = vrWIDE - eWIDE - abs(x);
-  if (i&YValue && i&YNegative) y = vrHIGH - eHIGH - abs(y);
-
+  hints.win_gravity = NorthWestGravity;
+  if (i&XValue && i&XNegative) {
+    hints.win_gravity = NorthEastGravity;
+    x = vrWIDE - (eWIDE + 2 * bwidth) - abs(x);
+  }
+  if (i&YValue && i&YNegative) {
+    hints.win_gravity = (hints.win_gravity == NorthWestGravity) ?
+	SouthWestGravity : SouthEastGravity;
+    y = vrHIGH - (eHIGH + 2 * bwidth) - abs(y);
+  }
+ 
   if (x+eWIDE > vrWIDE) x = vrWIDE - eWIDE;   /* keep on screen */
   if (y+eHIGH > vrHIGH) y = vrHIGH - eHIGH;
 
@@ -3253,7 +3260,7 @@
   hints.x = x;                  hints.y = y;
   hints.width = eWIDE;          hints.height = eHIGH;
   hints.max_width  = maxWIDE;   hints.max_height = maxHIGH;
-  hints.flags |= USSize | PMaxSize;
+  hints.flags |= USSize | PMaxSize | PWinGravity;
     
   xswa.bit_gravity = StaticGravity;
   xswa.background_pixel = bg;
@@ -3302,10 +3309,6 @@
     }
   }
 
-
-  XSetStandardProperties(theDisp,mainW,"","",None,NULL,0,&hints);
-  setWinIconNames(name);
-
   xwmh.input = True;
   xwmh.flags = InputHint;
 
@@ -3330,12 +3333,12 @@
       }
     }
   }
-  XSetWMHints(theDisp, mainW, &xwmh);
 
   classh.res_name = "xv";
   classh.res_class = "XVroot";
-  XSetClassHint(theDisp, mainW, &classh);
 
+  XmbSetWMProperties(theDisp, mainW, NULL, NULL, NULL, 0, &hints, &xwmh, &classh);
+  setWinIconNames(name);
 
   if (nodecor) {   /* turn of image window decorations (in MWM) */ 
     Atom mwm_wm_hints;
