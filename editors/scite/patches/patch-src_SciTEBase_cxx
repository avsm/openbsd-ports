$OpenBSD: patch-src_SciTEBase_cxx,v 1.2 2007/01/18 10:56:27 steven Exp $
--- src/SciTEBase.cxx.orig	Mon Jan 15 12:02:13 2007
+++ src/SciTEBase.cxx	Mon Jan 15 12:02:56 2007
@@ -2048,7 +2048,7 @@ void SciTEBase::EliminateDuplicateWords(
 
 		if (firstLen == secondLen &&
 		        !strncmp(firstWord, secondWord, firstLen)) {
-			strcpy(firstWord, secondWord);
+			strlcpy(firstWord, secondWord, firstLen);
 			firstSpace = strchr(firstWord, ' ');
 		} else {
 			firstWord = secondWord;
@@ -2176,7 +2176,7 @@ bool SciTEBase::StartInsertAbbreviation(
 	}
 
 	char *expbuf = new char[dataLength + 1];
-	strcpy(expbuf, data.c_str());
+	strlcpy(expbuf, data.c_str(), dataLength + 1);
 	UnSlash(expbuf);
 	size_t expbuflen = strlen(expbuf);
 	int caret_pos = SendEditor(SCI_GETSELECTIONSTART);
@@ -2322,7 +2322,7 @@ bool SciTEBase::StartExpandAbbreviation(
 	}
 
 	char *expbuf = new char[dataLength + 1];
-	strcpy(expbuf, data.c_str());
+	strlcpy(expbuf, data.c_str(), dataLength + 1);
 	UnSlash(expbuf);
 	size_t expbuflen = strlen(expbuf);
 	int caret_pos = -1; // caret position
@@ -2721,7 +2721,7 @@ void SciTEBase::SetTextProperties(
 	int eolMode = SendEditor(SCI_GETEOLMODE);
 	ps.Set("EOLMode", eolMode == SC_EOL_CRLF ? "CR+LF" : (eolMode == SC_EOL_LF ? "LF" : "CR"));
 
-	sprintf(temp, "%d", LengthDocument());
+	snprintf(temp, sizeof(temp), "%d", LengthDocument());
 	ps.Set("BufferLength", temp);
 
 	ps.SetInteger("NbOfLines", SendEditor(SCI_GETLINECOUNT));
@@ -2736,22 +2736,22 @@ void SciTEBase::SetTextProperties(
 		       int endPos = SendEditor(SCI_GETLINESELENDPOSITION, line);
 		       charCount += endPos - startPos;
 	       }
-	       sprintf(temp, "%ld", charCount);
+	       snprintf(temp, sizeof(temp), "%ld", charCount);
 	} else {
-		sprintf(temp, "%ld", crange.cpMax - crange.cpMin);
+		snprintf(temp, sizeof(temp), "%ld", crange.cpMax - crange.cpMin);
 	}
 	ps.Set("SelLength", temp);
 	int caretPos = SendEditor(SCI_GETCURRENTPOS);
 	int selAnchor = SendEditor(SCI_GETANCHOR);
 	if (0 == (crange.cpMax - crange.cpMin)) {
-		sprintf(temp, "%d", 0);
+		snprintf(temp, sizeof(temp), "%d", 0);
 	} else if (selLastLine == selFirstLine) {
-		sprintf(temp, "%d", 1);
+		snprintf(temp, sizeof(temp), "%d", 1);
 	} else if ((SendEditor(SCI_GETCOLUMN, caretPos) == 0 && (selAnchor <= caretPos)) ||
  		((SendEditor( SCI_GETCOLUMN, selAnchor) == 0) && (selAnchor > caretPos ))) {
-		sprintf(temp, "%d", selLastLine - selFirstLine);
+		snprintf(temp, sizeof(temp), "%d", selLastLine - selFirstLine);
 	} else {
-		sprintf(temp, "%d", selLastLine - selFirstLine + 1);
+		snprintf(temp, sizeof(temp), "%d", selLastLine - selFirstLine + 1);
 	}
 	ps.Set("SelHeight", temp);
 }
@@ -2770,7 +2770,7 @@ void SciTEBase::UpdateStatusBar(bool bUp
 		propsStatus.Set("OverType", SendEditor(SCI_GETOVERTYPE) ? "OVR" : "INS");
 
 		char sbKey[32];
-		sprintf(sbKey, "statusbar.text.%d", sbNum);
+		snprintf(sbKey, sizeof(sbKey), "statusbar.text.%d", sbNum);
 		SString msg = propsStatus.GetExpanded(sbKey);
 		if (msg.size() && sbValue != msg) {	// To avoid flickering, update only if needed
 			SetStatusBarText(msg.c_str());
@@ -4334,7 +4334,7 @@ void SciTEBase::Notify(SCNotification *n
 	case SCN_DWELLSTART: {
 			if (INVALID_POSITION == notification->position) {
 				char message[200];
-				sprintf(message, "%0d (%0d,%0d)", notification->position, notification->x, notification->y);
+				snprintf(message, sizeof(message), "%0d (%0d,%0d)", notification->position, notification->x, notification->y);
 			} else {
 				int endWord = notification->position;
 				SString message =
@@ -4657,11 +4657,11 @@ void SciTEBase::SendOneProperty(const ch
 	size_t keysize = strlen(kind) + 1 + strlen(key) + 1 + strlen(val) + 1;
 	char *m = new char[keysize];
 	if (m) {
-		strcpy(m, kind);
-		strcat(m, ":");
-		strcat(m, key);
-		strcat(m, "=");
-		strcat(m, val);
+		strlcpy(m, kind, keysize);
+		strlcat(m, ":", keysize);
+		strlcat(m, key, keysize);
+		strlcat(m, "=", keysize);
+		strlcat(m, val, keysize);
 		extender->SendProperty(m);
 		delete []m;
 	}
@@ -4699,12 +4699,14 @@ bool SciTEBase::RecordMacroCommand(SCNot
 		t = (char*)(notification->lParam);
 		if (t != NULL) {
 			//format : "<message>;<wParam>;1;<text>"
-			szMessage = new char[50 + strlen(t) + 4];
-			sprintf(szMessage, "%d;%ld;1;%s", notification->message, notification->wParam, t);
+			size_t szMessage_size = 50 + strlen(t) + 4;
+			szMessage = new char[szMessage_size];
+			snprintf(szMessage, szMessage_size, "%d;%ld;1;%s", notification->message, notification->wParam, t);
 		} else {
 			//format : "<message>;<wParam>;0;"
-			szMessage = new char[50];
-			sprintf(szMessage, "%d;%ld;0;", notification->message, notification->wParam);
+			size_t szMessage_size = 50;
+			szMessage = new char[szMessage_size];
+			snprintf(szMessage, szMessage_size, "%d;%ld;0;", notification->message, notification->wParam);
 		}
 		handled = extender->OnMacro("macro:record", szMessage);
 		delete []szMessage;
@@ -4794,7 +4796,7 @@ void SciTEBase::ExecuteMacroCommand(cons
 	//extract message,wParam ,lParam
 
 	uptr_t message = ReadNum(nextarg);
-	strncpy(params, nextarg, 3);
+	strlcpy(params, nextarg, sizeof(params));
 	nextarg += 4;
 	if (*(params + 1) == 'R') {
 		// in one function wParam is a string  : void SetProperty(string key,string name)
@@ -4804,7 +4806,7 @@ void SciTEBase::ExecuteMacroCommand(cons
 		int lstring1 = nextarg - s1;
 		string1 = new char[lstring1 + 1];
 		if (lstring1 > 0)
-			strncpy(string1, s1, lstring1);
+			strlcpy(string1, s1, lstring1+1);
 		*(string1 + lstring1) = '\0';
 		wParam = reinterpret_cast<uptr_t>(string1);
 		nextarg++;
@@ -4851,15 +4853,16 @@ void SciTEBase::ExecuteMacroCommand(cons
 	}
 
 	size_t alen = strlen(answercmd);
-	char *tbuff = new char[l + alen + 1];
-	strcpy(tbuff, answercmd);
+	size_t tbuff_size = l + alen + 1;
+	char *tbuff = new char[tbuff_size];
+	strlcpy(tbuff, answercmd, tbuff_size);
 	if (*params == 'S')
 		lParam = reinterpret_cast<sptr_t>(tbuff + alen);
 
 	if (l > 0)
 		rep = SendEditor(message, wParam, lParam);
 	if (*params == 'I')
-		sprintf(tbuff + alen, "%0d", rep);
+		snprintf(tbuff + alen, tbuff_size, "%0d", rep);
 	extender->OnMacro("macro", tbuff);
 	delete []tbuff;
 }
@@ -4916,7 +4919,7 @@ bool SciTEBase::ProcessCommandLine(SStri
 				if (wlArgs[i+1][3] == 'b')
 					gf = static_cast<GrepFlags>(gf | grepBinary);
 				char unquoted[1000];
-				strcpy(unquoted, wlArgs[i+3]);
+				strlcpy(unquoted, wlArgs[i+3], sizeof(unquoted));
 				UnSlash(unquoted);
 				InternalGrep(gf, FilePath::GetWorkingDirectory().AsInternal(), wlArgs[i+2], unquoted);
 				exit(0);
@@ -5005,9 +5008,10 @@ void SciTEBase::Trace(const char *s) {
 
 char *SciTEBase::Property(const char *key) {
 	SString value = props.GetExpanded(key);
-	char *retval = new char[value.length() + 1];
+	size_t retval_size = value.length() + 1;
+	char *retval = new char[retval_size];
 	if (retval)
-		strcpy(retval, value.c_str());
+		strlcpy(retval, value.c_str(), retval_size);
 	return retval;
 }
 
