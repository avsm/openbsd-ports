$OpenBSD: patch-ngrep_c,v 1.4 2011/06/16 17:42:56 sthen Exp $
--- ngrep.c.orig	Tue Nov 28 13:38:43 2006
+++ ngrep.c	Thu Jun 16 18:40:08 2011
@@ -92,7 +92,7 @@
 #endif
 
 #if USE_PCRE
-#include "pcre-5.0/pcre.h"
+#include "pcre.h"
 #else
 #include "regex-0.12/regex.h"
 #endif
@@ -391,7 +391,7 @@ int main(int argc, char **argv) {
             filter = get_filter_from_argv(&argv[optind-1]);
 
 #if USE_PCAP_RESTART
-            PCAP_RESTART_FUNC();
+            PCAP_RESTART_FUNC(NULL);
 #endif
             if (pcap_compile(pd, &pcapfilter, filter, 0, mask.s_addr)) {
                 pcap_perror(pd, "pcap compile");
@@ -549,6 +549,10 @@ int main(int argc, char **argv) {
             link_offset = PPPHDR_SIZE;
             break;
 
+        case DLT_PPP_ETHER:
+            link_offset = PPPOEHDR_SIZE;
+            break;
+
 #if HAVE_DLT_LOOP
         case DLT_LOOP:
 #endif
@@ -1197,6 +1201,14 @@ void drop_privs(void) {
             perror("attempt to drop privileges failed");
             clean_exit(-1);
         }
+    if (chroot("/var/empty") == -1) {
+        perror("attempt to drop privileges failed: chroot failed");
+        clean_exit(-1);
+    }
+    if (chdir("/") == -1) {
+        perror("attempt to drop privileges failed: chdir failed");
+        clean_exit(-1);
+    }
 
     if (((getgid()  != newgid) && (setgid(newgid)  == -1)) ||
         ((getegid() != newgid) && (setegid(newgid) == -1)) ||
