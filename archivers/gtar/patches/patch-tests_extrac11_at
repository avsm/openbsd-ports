$OpenBSD: patch-tests_extrac11_at,v 1.1 2010/10/28 13:50:30 naddy Exp $
--- tests/extrac11.at.orig	Sun Oct 24 20:07:46 2010
+++ tests/extrac11.at	Thu Oct 28 15:10:15 2010
@@ -45,31 +45,37 @@ for dir in $dirs; do
   done
 done
 
-# Check that "ulimit" itself works.
-((ulimit -n 100 &&
-  tar -cf archive1.tar a 3<&- 4<&- 5<&- 6<&- 7<&- 8<&- 9<&- &&
-  tar -xf archive1.tar -C dest1 a 3<&- 4<&- 5<&- 6<&- 7<&- 8<&- 9<&-
- ) &&
- diff -r a dest1/a
+# Check that "ulimit" itself works.  Close file descriptors before
+# invoking ulimit, to work around a bug (or a "feature") in some shells,
+# where they squirrel away dups of file descriptors into FD 10 and up
+# before closing the originals.
+( (exec 3<&- 4<&- 5<&- 6<&- 7<&- 8<&- 9<&- &&
+   ulimit -n 100 &&
+   tar -cf archive1.tar a &&
+   tar -xf archive1.tar -C dest1 a
+  ) &&
+  diff -r a dest1/a
 ) >/dev/null 2>&1 ||
    AT_SKIP_TEST
 
 # Another test that "ulimit" itself works:
 # tar should fail when completely starved of file descriptors.
-((ulimit -n 4 &&
-  tar -cf archive2.tar a 3<&- 4<&- 5<&- 6<&- 7<&- 8<&- 9<&- &&
-  tar -xf archive2.tar -C dest2 a 3<&- 4<&- 5<&- 6<&- 7<&- 8<&- 9<&-
- ) &&
- diff -r a dest2/a
+( (exec 3<&- 4<&- 5<&- 6<&- 7<&- 8<&- 9<&- &&
+   ulimit -n 4 &&
+   tar -cf archive2.tar a &&
+   tar -xf archive2.tar -C dest2 a
+  ) &&
+  diff -r a dest2/a
 ) >/dev/null 2>&1 &&
    AT_SKIP_TEST
 
 # Tar should work when there are few, but enough, file descriptors.
-((ulimit -n 10 &&
-  tar -cf archive3.tar a 3<&- 4<&- 5<&- 6<&- 7<&- 8<&- 9<&- &&
-  tar -xf archive3.tar -C dest3 a 3<&- 4<&- 5<&- 6<&- 7<&- 8<&- 9<&-
- ) &&
- diff -r a dest3/a >/dev/null 2>&1
+( (exec 3<&- 4<&- 5<&- 6<&- 7<&- 8<&- 9<&- &&
+   ulimit -n 10 &&
+   tar -cf archive3.tar a &&
+   tar -xf archive3.tar -C dest3 a
+  ) &&
+  diff -r a dest3/a >/dev/null 2>&1
 ) || { diff -r a dest3/a; exit 1; }
 ],
 [0],[],[],[],[],[gnu])
