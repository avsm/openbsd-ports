$OpenBSD: patch-ext_imap_config_m4,v 1.2 2001/11/19 01:50:34 brad Exp $
--- ext/imap/config.m4.orig	Mon May 21 20:38:46 2001
+++ ext/imap/config.m4	Sun Nov 18 17:12:56 2001
@@ -22,8 +22,12 @@ AC_DEFUN(IMAP_LIB_CHK,[
 ])
 
 AC_DEFUN(PHP_IMAP_KRB_CHK, [
-  PHP_ARG_WITH(kerberos,for Kerberos support in IMAP,
-  [  --with-kerberos[=DIR]     IMAP: Include Kerberos support.])
+  AC_ARG_WITH(kerberos,
+  [  --with-kerberos[=DIR]     IMAP: Include Kerberos support. DIR is the Kerberos install dir.],[
+    PHP_KERBEROS=$withval
+  ],[
+    PHP_KERBEROS=no
+  ])
 
   if test "$PHP_KERBEROS" = "yes"; then
     test -d /usr/kerberos && PHP_KERBEROS=/usr/kerberos
@@ -32,31 +36,44 @@ AC_DEFUN(PHP_IMAP_KRB_CHK, [
   if test "$PHP_KERBEROS" != "no"; then
     AC_DEFINE(HAVE_IMAP_KRB,1,[ ])
     PHP_ADD_LIBPATH($PHP_KERBEROS/lib, IMAP_SHARED_LIBADD)
-    PHP_ADD_LIBRARY(gssapi_krb5, 1, IMAP_SHARED_LIBADD)
+    PHP_ADD_LIBRARY(gssapi, 1, IMAP_SHARED_LIBADD)
     PHP_ADD_LIBRARY(krb5, 1, IMAP_SHARED_LIBADD)
-    PHP_ADD_LIBRARY(k5crypto, 1, IMAP_SHARED_LIBADD)
-    PHP_ADD_LIBRARY(com_err,  1, IMAP_SHARED_LIBADD)
+    PHP_ADD_LIBRARY(asn1, 1, IMAP_SHARED_LIBADD)
+    PHP_ADD_LIBRARY(com_err_pic,  1, IMAP_SHARED_LIBADD)
+  else
+    AC_EGREP_HEADER(auth_gss, $IMAP_INC_DIR/linkage.h, [
+      AC_MSG_ERROR(This c-client library is build with Kerberos support. 
+
+      Add --with-kerberos<=DIR> to your configure line. Check config.log for details.)
+    ])
   fi
+
 ])
 
 AC_DEFUN(PHP_IMAP_SSL_CHK, [
-  PHP_ARG_WITH(imap-ssl,for SSL support in IMAP,
-  [  --with-imap-ssl[=DIR]     IMAP: Include SSL support.])
+  AC_ARG_WITH(imap-ssl,
+  [  --with-imap-ssl[=DIR]     IMAP: Include SSL support. DIR is the OpenSSL install dir.],[
+    PHP_IMAP_SSL=$withval
+  ],[
+    PHP_IMAP_SSL=no
+  ])
 
   if test "$PHP_IMAP_SSL" = "yes"; then
     PHP_IMAP_SSL=/usr
   fi
 
   if test "$PHP_IMAP_SSL" != "no"; then
+    AC_DEFINE(HAVE_IMAP_SSL,1,[ ])
     PHP_ADD_LIBPATH($PHP_IMAP_SSL/lib, IMAP_SHARED_LIBADD)
-    PHP_ADD_LIBRARY_DEFER(crypto)
-    PHP_ADD_LIBRARY_DEFER(ssl)
-
+    PHP_ADD_LIBRARY_DEFER(ssl,, IMAP_SHARED_LIBADD)
+    PHP_ADD_LIBRARY_DEFER(crypto,, IMAP_SHARED_LIBADD)
+  else
     old_LIBS=$LIBS
-    LIBS="$LIBS -lc-client"
+    LIBS="$LIBS -L$IMAP_LIBDIR -l$IMAP_LIB"
     if test $PHP_KERBEROS != "no"; then
-      LIBS="$LIBS -lgssapi_krb5 -lkrb5 -lk5crypto -lcom_err"
+      LIBS="$LIBS -L$PHP_KERBEROS/lib -lgssapi -lkrb5 -lasn1 -lcom_err_pic"
     fi
+
     AC_TRY_RUN([
       void mm_log(void){}
       void mm_dlog(void){}
@@ -73,15 +90,15 @@ AC_DEFUN(PHP_IMAP_SSL_CHK, [
       void mm_exists(void){}
       void mm_searched(void){}
       void mm_expunged(void){}
-      char ssl_onceonlyinit();
+      char mail_open();
       int main() {
-        ssl_onceonlyinit();
+        mail_open(0,"",0);
         return 0;
       }
-    ],[
-      AC_DEFINE(HAVE_IMAP_SSL,1,[ ])
-    ], [
-      AC_MSG_ERROR(This c-client library does not support SSL. Recompile or remove --with-imap-ssl from configure line.)
+    ],,[
+      AC_MSG_ERROR(This c-client library is build with SSL support. 
+      
+      Add --with-imap-ssl<=DIR> to your configure line. Check config.log for details.)
     ])
     LIBS=$old_LIBS
   fi
@@ -108,8 +125,21 @@ if test "$PHP_IMAP" != "no"; then  
       fi
     done
 
+    old_CPPFLAGS=$CPPFLAGS
+    CPPFLAGS=-I$IMAP_INC_DIR
+    AC_EGREP_CPP(this_is_true, [
+      #include "imap4r1.h"
+      #if defined(IMAPSSLPORT)
+      this_is_true
+      #endif
+    ],[
+      AC_DEFINE(HAVE_IMAP2001, 1, [ ])
+    ],[ ])
+    CPPFLAGS=$old_CPPFLAGS
+
     AC_CHECK_LIB(pam, pam_start) 
-    
+    AC_CHECK_LIB(crypt, crypt)
+	    
     PHP_EXPAND_PATH($IMAP_DIR, IMAP_DIR)
 
     if test -z "$IMAP_DIR"; then
@@ -122,7 +152,7 @@ if test "$PHP_IMAP" != "no"; then  
       ln -s "$IMAP_DIR/lib/c-client.a" "$IMAP_DIR/lib/libc-client.a" >/dev/null 2>&1
     fi
 
-    for lib in imap c-client4 c-client; do
+    for lib in c-client4 c-client imap; do
       IMAP_LIB=$lib
       IMAP_LIB_CHK(lib)
       IMAP_LIB_CHK(c-client)
@@ -134,7 +164,7 @@ if test "$PHP_IMAP" != "no"; then  
 
     PHP_ADD_INCLUDE($IMAP_INC_DIR)
     PHP_ADD_LIBPATH($IMAP_LIBDIR, IMAP_SHARED_LIBADD)
-    PHP_ADD_LIBRARY_DEFER($IMAP_LIB)
+    PHP_ADD_LIBRARY_DEFER($IMAP_LIB,, IMAP_SHARED_LIBADD)
     PHP_IMAP_KRB_CHK
     PHP_IMAP_SSL_CHK
 fi
