$OpenBSD: patch-src_tcp_c,v 1.1 2005/02/20 07:19:57 david Exp $
--- src/tcp.c.orig	2004-12-21 13:09:54.000000000 -0600
+++ src/tcp.c	2005-02-20 01:14:55.000000000 -0600
@@ -596,9 +596,10 @@ static void TCPDispatchPeer (Connection 
         return;
     }
 
+    peer->connect &= ~CONNECT_SELECT_W;
     /* Recv all packets before doing anything else.
          The objective is to delete any packets CANCELLED by the remote user. */
-    while (UtilIOSelectIs (peer->sok, READFDS) && i++ <= TCP_MSG_QUEUE)
+    while (UtilIOSelectIs (peer->sok, READFDS | WRITEFDS) && i++ <= TCP_MSG_QUEUE)
     {
         if (!(pak = TCPReceivePacket (peer)))
             return;
@@ -645,7 +646,6 @@ static void TCPDispatchPeer (Connection 
         UtilIOSelectAdd (peer->sok, READFDS);
         UtilIOSelect();
     }
-    peer->connect &= ~CONNECT_SELECT_W;
 }
 
 /*********************************************/
