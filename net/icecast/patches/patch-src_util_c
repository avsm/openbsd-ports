$OpenBSD: patch-src_util_c,v 1.1 2005/04/16 15:37:31 sturm Exp $
--- src/util.c.orig	Mon Nov  8 02:21:54 2004
+++ src/util.c	Mon Mar  7 14:10:16 2005
@@ -229,12 +229,14 @@ char *util_get_path_from_normalised_uri(
     char *fullpath;
     char *webroot;
     ice_config_t *config = config_get_config();
+    size_t pathlen;
 
     webroot = config->webroot_dir;
 
-    fullpath = malloc(strlen(uri) + strlen(webroot) + 1);
+    pathlen = strlen(uri) + strlen(webroot) + 1;
+    fullpath = malloc(pathlen);
     if (fullpath)
-        sprintf (fullpath, "%s%s", webroot, uri);
+        snprintf(fullpath, pathlen, "%s%s", webroot, uri);
     config_release_config();
 
     return fullpath;
@@ -568,24 +570,29 @@ char *util_dict_urlencode(util_dict *dic
     char *res, *tmp;
     char *enc;
     int start = 1;
+    size_t buflen;
 
     for (res = NULL; dict; dict = dict->next) {
         /* encode key */
         if (!dict->key)
             continue;
         if (start) {
-            if (!(res = malloc(strlen(dict->key) + 1))) {
+            buflen = strlen(dict->key) + 1;
+            if (!(res = malloc(buflen))) {
                 return NULL;
             }
-            sprintf(res, "%s", dict->key);
+            snprintf(res, buflen, "%s", dict->key);
             start = 0;
         } else {
-            if (!(tmp = realloc(res, strlen(res) + strlen(dict->key) + 2))) {
+            buflen = strlen(res) + strlen(dict->key) + 2;
+            if ((tmp = realloc(res, buflen)) == NULL) {
                 free(res);
+                res = NULL;
                 return NULL;
-            } else
+            } else {
                 res = tmp;
-            sprintf(res + strlen(res), "%c%s", delim, dict->key);
+                snprintf(res + strlen(res), buflen - strlen(res), "%c%s", delim, dict->key);
+            }
         }
 
         /* encode value */
@@ -596,14 +603,18 @@ char *util_dict_urlencode(util_dict *dic
             return NULL;
         }
 
-        if (!(tmp = realloc(res, strlen(res) + strlen(enc) + 2))) {
+        buflen = strlen(res) + strlen(enc) + 2;
+        if ((tmp = realloc(res, buflen)) == NULL) {
             free(enc);
             free(res);
+            enc = res = NULL;
             return NULL;
-        } else
+        } else {
             res = tmp;
-        sprintf(res + strlen(res), "=%s", enc);
-        free(enc);
+            snprintf(res + strlen(res), buflen - strlen(res), "=%s", enc);
+            free(enc);
+            enc = NULL;
+        }
     }
 
     return res;
