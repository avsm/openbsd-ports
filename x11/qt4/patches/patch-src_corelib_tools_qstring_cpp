$OpenBSD: patch-src_corelib_tools_qstring_cpp,v 1.1 2007/03/31 23:10:18 espie Exp $
--- src/corelib/tools/qstring.cpp.orig	Wed Feb 21 10:58:43 2007
+++ src/corelib/tools/qstring.cpp	Sat Mar 31 15:01:10 2007
@@ -3352,6 +3352,7 @@ QString QString::fromUtf8(const char *str, int size)
     result.resize(size); // worst case
     ushort *qch = result.d->data;
     uint uc = 0;
+    uint min_uc = 0;
     int need = 0;
     int error = -1;
     uchar ch;
@@ -3369,6 +3370,12 @@ QString QString::fromUtf8(const char *str, int size)
                         ushort low = uc%0x400 + 0xdc00;
                         *qch++ = high;
                         *qch++ = low;
+                    } else if ((uc < min_uc) || (uc >= 0xd800 && uc <= 0xdfff) || (uc >= 0xfffe)) {
+			// overlong seqence, UTF16 surrogate or BOM
+                        i = error;
+                        qch = addOne(qch, result);
+                        *qch++ = 0xdbff;
+                        *qch++ = 0xde00 + ((uchar)str[i]);
                     } else {
                         *qch++ = uc;
                     }
@@ -3391,14 +3398,17 @@ QString QString::fromUtf8(const char *str, int size)
                 uc = ch & 0x1f;
                 need = 1;
                 error = i;
+                min_uc = 0x80;
             } else if ((ch & 0xf0) == 0xe0) {
                 uc = ch & 0x0f;
                 need = 2;
                 error = i;
+                min_uc = 0x800;
             } else if ((ch&0xf8) == 0xf0) {
                 uc = ch & 0x07;
                 need = 3;
                 error = i;
+                min_uc = 0x10000;
             } else {
                 // Error
                 qch = addOne(qch, result);
